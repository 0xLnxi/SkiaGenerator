# Skia + Dawn å…¨å¹³å°æ„å»ºå·¥ä½œæµ
name: ç¼–è¯‘ Skia + Dawn å…¨å¹³å°æ„å»ºåŒ…

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ8ç‚¹ï¼ˆUTCæ—¶é—´0ç‚¹ï¼‰æ‰§è¡Œä¸€æ¬¡
    - cron: '0 0 * * *'

# è®¾ç½®å·¥ä½œæµæƒé™
permissions:
  contents: write
  packages: write
  actions: read

env:
  # ç»Ÿä¸€æ„å»ºç±»å‹ä¸ºRelWithDebInfo
  BUILD_TYPE: RelWithDebInfo

jobs:
  build-skia-dawn:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows x64æ¶æ„
          - os: windows-2022
            platform: x64_windows
            arch: x64
            target_os: win
            target_cpu: x64
            compiler: msvc2022
            
          # Linux x64æ¶æ„  
          - os: ubuntu-24.04
            platform: x64_linux
            arch: x64
            target_os: linux
            target_cpu: x64
            compiler: clang18
            
          # Android x64æ¶æ„
          - os: ubuntu-24.04
            platform: x64_android
            arch: x64
            target_os: android
            target_cpu: x64
            android_api: 21
            compiler: clang18
            
          # Android ARM64æ¶æ„
          - os: ubuntu-24.04
            platform: arm64_android
            arch: arm64
            target_os: android
            target_cpu: arm64
            android_api: 21
            compiler: clang18

    steps:
    # æ£€å‡ºä»£ç ä»“åº“
    - name: æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4
      
    # è®¾ç½®Pythonè¿è¡Œç¯å¢ƒ
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    # å®‰è£…Linuxç³»ç»Ÿä¾èµ–åŒ…ï¼ˆLinuxå’ŒAndroidæ„å»ºéœ€è¦ï¼‰
    - name: å®‰è£…Linuxç³»ç»Ÿä¾èµ–
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        # å®‰è£…åŸºç¡€æ„å»ºå·¥å…·
        sudo apt-get install -y build-essential ninja-build cmake
        # å®‰è£…ç¼–è¯‘å™¨
        sudo apt-get install -y clang-18 gcc-13 g++-13
        # å®‰è£…å›¾å½¢å’Œå­—ä½“ç›¸å…³ä¾èµ–
        sudo apt-get install -y libfontconfig1-dev libfreetype6-dev libgl1-mesa-dev
        # å®‰è£…Vulkanå¼€å‘åº“
        sudo apt-get install -y libvulkan-dev vulkan-tools
        # å®‰è£…X11ç›¸å…³åº“
        sudo apt-get install -y libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev libx11-dev
        # å®‰è£…ICUå’ŒHarfBuzz
        sudo apt-get install -y libicu-dev libharfbuzz-dev
        # å®‰è£…Javaå¼€å‘ç¯å¢ƒï¼ˆAndroidæ„å»ºéœ€è¦ï¼‰
        sudo apt-get install -y openjdk-11-jdk
        # è®¾ç½®ç¼–è¯‘å™¨ä¼˜å…ˆçº§
        sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-18 100
        sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-18 100
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 100
        
    # å®‰è£…Windowsç³»ç»Ÿä¾èµ–
    - name: å®‰è£…Windowsç³»ç»Ÿä¾èµ–
      if: runner.os == 'Windows'
      run: |
        # å®‰è£…ninjaæ„å»ºå·¥å…·
        choco install ninja -y
        # å®‰è£…LLVM 18ç”¨äºClangç¼–è¯‘å™¨
        choco install llvm --version=18.1.8 --force -y
        echo "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        
    # è®¾ç½®Visual Studioç¯å¢ƒ
    - name: è®¾ç½®Visual Studioç¯å¢ƒ
      if: runner.os == 'Windows'
      uses: microsoft/setup-msbuild@v2
      
    # è®¾ç½®Android NDKç¯å¢ƒï¼ˆä»…é™Androidå¹³å°ï¼‰
    - name: è®¾ç½®Android NDK
      if: matrix.target_os == 'android'
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r26d
        
    # è·å–Googleçš„depot_toolså·¥å…·é›†
    - name: è·å–depot_tools
      run: |
        git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
        echo "${{ github.workspace }}/depot_tools" >> $GITHUB_PATH
      shell: bash
      
    # è®¾ç½®Windowsç³»ç»Ÿçš„depot_toolsç¯å¢ƒå˜é‡
    - name: è®¾ç½®depot_toolsç¯å¢ƒå˜é‡
      if: runner.os == 'Windows'
      run: |
        echo "${{ github.workspace }}\depot_tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        # ç¦ç”¨depot_toolsè‡ªåŠ¨ä¸‹è½½å·¥å…·é“¾
        echo "DEPOT_TOOLS_WIN_TOOLCHAIN=0" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        
    # è·å–Skiaæºä»£ç å¹¶åŒæ­¥ä¾èµ–
    - name: è·å–Skiaæºä»£ç 
      run: |
        export PATH=${{ github.workspace }}/depot_tools:$PATH
        mkdir skia-build
        cd skia-build
        gclient config --name skia https://skia.googlesource.com/skia.git
        gclient sync
      shell: bash
      
    # è·å–Dawnæºä»£ç å¹¶åŒæ­¥ä¾èµ–
    - name: è·å–Dawnæºä»£ç 
      run: |
        git clone --recursive https://dawn.googlesource.com/dawn.git dawn-source
        cd dawn-source
        python3 tools/fetch_dawn_dependencies.py
      shell: bash
      
    # é…ç½®Dawnæ„å»ºå‚æ•°
    - name: é…ç½®Dawnæ„å»ºå‚æ•°
      run: |
        cd dawn-source
        mkdir -p build-${{ matrix.platform }}
        cd build-${{ matrix.platform }}
        
        # æ ¹æ®ä¸åŒå¹³å°è®¾ç½®CMakeé…ç½®
        case "${{ matrix.target_os }}" in
          "win")
            # Windowså¹³å°ä½¿ç”¨MSVC 2022
            cmake .. -G "Visual Studio 17 2022" -A ${{ matrix.arch == 'x64' && 'x64' || 'Win32' }} \
              -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
              -DDAWN_BUILD_SAMPLES=OFF \
              -DDAWN_BUILD_TESTS=OFF \
              -DDAWN_ENABLE_D3D11=ON \
              -DDAWN_ENABLE_D3D12=ON \
              -DDAWN_ENABLE_VULKAN=ON \
              -DDAWN_ENABLE_OPENGL=ON \
              -DCMAKE_CXX_STANDARD=20 \
              -DDAWN_USE_BUILT_DXC=ON
            ;;
          "linux")
            # Linuxå¹³å°ä½¿ç”¨Clang 18
            cmake .. -G Ninja \
              -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
              -DCMAKE_C_COMPILER=clang-18 \
              -DCMAKE_CXX_COMPILER=clang++-18 \
              -DDAWN_BUILD_SAMPLES=OFF \
              -DDAWN_BUILD_TESTS=OFF \
              -DDAWN_ENABLE_VULKAN=ON \
              -DDAWN_ENABLE_OPENGL=ON \
              -DCMAKE_CXX_STANDARD=20
            ;;
          "android")
            # Androidå¹³å°é…ç½®
            if [ "${{ matrix.arch }}" = "arm64" ]; then
              ANDROID_ABI="arm64-v8a"
            else
              ANDROID_ABI="x86_64"
            fi
            
            cmake .. -G Ninja \
              -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
              -DCMAKE_SYSTEM_NAME=Android \
              -DCMAKE_ANDROID_ARCH_ABI=${ANDROID_ABI} \
              -DCMAKE_ANDROID_NDK=${ANDROID_NDK_HOME} \
              -DCMAKE_ANDROID_STL_TYPE=c++_static \
              -DCMAKE_ANDROID_API=${{ matrix.android_api }} \
              -DDAWN_BUILD_SAMPLES=OFF \
              -DDAWN_BUILD_TESTS=OFF \
              -DDAWN_ENABLE_VULKAN=ON \
              -DDAWN_ENABLE_OPENGLES=ON \
              -DCMAKE_CXX_STANDARD=20
            ;;
        esac
      shell: bash
      
    # ç¼–è¯‘Dawn
    - name: ç¼–è¯‘Dawn
      run: |
        cd dawn-source/build-${{ matrix.platform }}
        
        case "${{ matrix.target_os }}" in
          "win")
            # Windowså¹³å°ä½¿ç”¨MSBuild
            cmake --build . --config ${{ env.BUILD_TYPE }} --parallel 4
            ;;
          *)
            # Linuxå’ŒAndroidå¹³å°ä½¿ç”¨Ninja
            ninja -j4
            ;;
        esac
        
        echo "âœ… Dawnç¼–è¯‘å®Œæˆ"
      shell: bash
      
    # é…ç½®Skiaæ„å»ºå‚æ•°
    - name: é…ç½®Skiaæ„å»ºå‚æ•°
      run: |
        cd skia-build/skia
        export PATH=${{ github.workspace }}/depot_tools:$PATH
        python3 tools/git-sync-deps
        
        # åŸºç¡€æ„å»ºå‚æ•°è®¾ç½®
        args="is_official_build=false"
        args="$args is_debug=false"
        args="$args extra_cflags=[\"-O2\", \"-g\"]"
        args="$args skia_use_dawn=true"
        args="$args skia_dawn_dir=\"../../dawn-source\""
        
        # å¯ç”¨ç³»ç»Ÿåº“
        args="$args skia_use_system_expat=false"
        args="$args skia_use_system_icu=false"
        args="$args skia_use_system_libjpeg_turbo=false"
        args="$args skia_use_system_libpng=false"
        args="$args skia_use_system_libwebp=false"
        args="$args skia_use_system_zlib=false"
        
        # å¯ç”¨å…¨é‡åŠŸèƒ½æ”¯æŒ
        args="$args skia_enable_pdf=true"
        args="$args skia_enable_skottie=true"
        args="$args skia_enable_skshaper=true"
        args="$args skia_enable_svg=true"
        args="$args skia_use_icu=true"
        
        # å¯ç”¨GPUåç«¯æ”¯æŒ
        args="$args skia_enable_gpu=true"
        args="$args skia_use_gl=true"
        args="$args skia_use_vulkan=true"
        args="$args skia_enable_spirv_validation=false"
        
        # ç¦ç”¨å·¥å…·æ„å»º
        args="$args skia_enable_tools=false"
        
        # è®¾ç½®ç›®æ ‡å¹³å°å’Œæ¶æ„
        args="$args target_os=\"${{ matrix.target_os }}\""
        args="$args target_cpu=\"${{ matrix.target_cpu }}\""
        
        # æ ¹æ®ä¸åŒå¹³å°è®¾ç½®ç‰¹å®šå‚æ•°
        case "${{ matrix.target_os }}" in
          "win")
            # Windowså¹³å°ç‰¹å®šé…ç½®
            args="$args skia_use_angle=true"
            args="$args skia_use_direct3d=true"
            args="$args skia_use_freetype=true"
            args="$args skia_use_system_freetype2=false"
            args="$args skia_use_harfbuzz=true"
            args="$args skia_use_system_harfbuzz=false"
            # ä½¿ç”¨Clangç¼–è¯‘å™¨
            args="$args cc=\"clang\""
            args="$args cxx=\"clang++\""
            args="$args clang_win=\"C:/Program Files/LLVM\""
            ;;
          "linux")
            # Linuxå¹³å°ç‰¹å®šé…ç½®
            args="$args skia_use_x11=true"
            args="$args skia_use_freetype=true"
            args="$args skia_use_fontconfig=true"
            args="$args skia_use_harfbuzz=true"
            args="$args cc=\"clang-18\""
            args="$args cxx=\"clang++-18\""
            ;;
          "android")
            # Androidå¹³å°ç‰¹å®šé…ç½®
            args="$args ndk=\"$ANDROID_NDK_HOME\""
            args="$args android_api_level=${{ matrix.android_api }}"
            args="$args skia_use_system_freetype2=false"
            args="$args skia_use_freetype=true"
            args="$args skia_enable_fontmgr_android=true"
            args="$args skia_use_vulkan=true"
            args="$args skia_use_harfbuzz=true"
            args="$args skia_use_system_harfbuzz=false"
            ;;
        esac
        
        echo "BUILD_ARGS=$args" >> $GITHUB_ENV
      shell: bash
      
    # ä½¿ç”¨GNç”ŸæˆSkiaæ„å»ºæ–‡ä»¶
    - name: ç”ŸæˆSkiaæ„å»ºæ–‡ä»¶
      run: |
        cd skia-build/skia
        export PATH=${{ github.workspace }}/depot_tools:$PATH
        echo "æ­£åœ¨ä¸º ${{ matrix.target_os }} å¹³å°ç”ŸæˆSkiaæ„å»ºæ–‡ä»¶..."
        bin/gn gen out/Release --args="$BUILD_ARGS"
        echo "Skiaæ„å»ºé…ç½®å®Œæˆ"
      shell: bash
      
    # ç¼–è¯‘Skia
    - name: ç¼–è¯‘Skia
      run: |
        cd skia-build/skia
        export PATH=${{ github.workspace }}/depot_tools:$PATH
        echo "å¼€å§‹ç¼–è¯‘ ${{ matrix.target_os }} å¹³å°çš„Skia..."
        ninja -C out/Release -j4
        echo "âœ… ${{ matrix.target_os }} å¹³å°Skiaç¼–è¯‘å®Œæˆ"
      shell: bash
      
    # æ”¶é›†Dawnç”Ÿæˆæ–‡ä»¶
    - name: æ”¶é›†Dawnç”Ÿæˆæ–‡ä»¶
      run: |
        mkdir -p dawn-generated/include/dawn
        mkdir -p dawn-generated/include/webgpu
        mkdir -p dawn-generated/src/dawn
        mkdir -p dawn-generated/src/emdawnwebgpu
        mkdir -p dawn-generated/webgpu-headers
        
        # å¤åˆ¶ç”Ÿæˆçš„å¤´æ–‡ä»¶å’Œæºç 
        if [ -d "dawn-source/build-${{ matrix.platform }}/gen/include/dawn" ]; then
          cp -r dawn-source/build-${{ matrix.platform }}/gen/include/dawn/* dawn-generated/include/dawn/ 2>/dev/null || true
        fi
        
        if [ -d "dawn-source/build-${{ matrix.platform }}/gen/include/webgpu" ]; then
          cp -r dawn-source/build-${{ matrix.platform }}/gen/include/webgpu/* dawn-generated/include/webgpu/ 2>/dev/null || true
        fi
        
        if [ -d "dawn-source/build-${{ matrix.platform }}/gen/src/dawn" ]; then
          cp -r dawn-source/build-${{ matrix.platform }}/gen/src/dawn/* dawn-generated/src/dawn/ 2>/dev/null || true
        fi
        
        if [ -d "dawn-source/build-${{ matrix.platform }}/gen/src/emdawnwebgpu" ]; then
          cp -r dawn-source/build-${{ matrix.platform }}/gen/src/emdawnwebgpu/* dawn-generated/src/emdawnwebgpu/ 2>/dev/null || true
        fi
        
        if [ -d "dawn-source/build-${{ matrix.platform }}/gen/webgpu-headers" ]; then
          cp -r dawn-source/build-${{ matrix.platform }}/gen/webgpu-headers/* dawn-generated/webgpu-headers/ 2>/dev/null || true
        fi
        
        echo "âœ… Dawnç”Ÿæˆæ–‡ä»¶æ”¶é›†å®Œæˆ"
      shell: bash
      
    # åˆ›å»ºå‘å¸ƒåŒ…å¹¶æ•´ç†æ–‡ä»¶
    - name: åˆ›å»ºSkia+Dawnå‘å¸ƒåŒ…
      run: |
        # åˆ›å»ºè¾“å‡ºç›®å½•ç»“æ„
        mkdir -p Skia/include/core
        mkdir -p Skia/include/dawn
        mkdir -p Skia/include/modules
        mkdir -p Skia/lib/${{ matrix.target_os }}/${{ matrix.arch }}
        mkdir -p Skia/bin/${{ matrix.target_os }}/${{ matrix.arch }}
        
        # å¤åˆ¶Skiaå¤´æ–‡ä»¶
        cp -r skia-build/skia/include/* Skia/include/core/
        cp -r skia-build/skia/modules/* Skia/include/modules/ 2>/dev/null || true
        
        # å¤åˆ¶Dawnå¤´æ–‡ä»¶å’Œç”Ÿæˆæ–‡ä»¶
        cp -r dawn-source/include/* Skia/include/dawn/ 2>/dev/null || true
        cp -r dawn-generated/include/dawn/* Skia/include/dawn/ 2>/dev/null || true
        cp -r dawn-generated/include/webgpu/* Skia/include/dawn/ 2>/dev/null || true
        
        # å¤åˆ¶third_partyä¸­çš„modulesç›¸å…³æ–‡ä»¶
        if [ -d "skia-build/skia/third_party" ]; then
          mkdir -p Skia/third_party
          # å¤åˆ¶skcmsæ¨¡å—
          if [ -d "skia-build/skia/third_party/skcms" ]; then
            cp -r skia-build/skia/third_party/skcms Skia/third_party/ 2>/dev/null || true
          fi
        fi
        
        # æ ¹æ®ä¸åŒå¹³å°å¤åˆ¶åº“æ–‡ä»¶å’Œå¯æ‰§è¡Œæ–‡ä»¶
        case "${{ matrix.target_os }}" in
          "win")
            # Windowså¹³å°æ–‡ä»¶å¤åˆ¶
            find skia-build/skia/out/Release -name "*.lib" -exec cp {} Skia/lib/${{ matrix.target_os }}/${{ matrix.arch }}/ \; 2>/dev/null || true
            find skia-build/skia/out/Release -name "*.dll" -exec cp {} Skia/bin/${{ matrix.target_os }}/${{ matrix.arch }}/ \; 2>/dev/null || true
            find dawn-source/build-${{ matrix.platform }}/${{ env.BUILD_TYPE }} -name "*.lib" -exec cp {} Skia/lib/${{ matrix.target_os }}/${{ matrix.arch }}/ \; 2>/dev/null || true
            find dawn-source/build-${{ matrix.platform }}/${{ env.BUILD_TYPE }} -name "*.dll" -exec cp {} Skia/bin/${{ matrix.target_os }}/${{ matrix.arch }}/ \; 2>/dev/null || true
            ;;
          "linux"|"android")
            # Linuxå’ŒAndroidå¹³å°æ–‡ä»¶å¤åˆ¶
            find skia-build/skia/out/Release -name "*.a" -exec cp {} Skia/lib/${{ matrix.target_os }}/${{ matrix.arch }}/ \; 2>/dev/null || true
            find skia-build/skia/out/Release -name "*.so" -exec cp {} Skia/lib/${{ matrix.target_os }}/${{ matrix.arch }}/ \; 2>/dev/null || true
            find dawn-source/build-${{ matrix.platform }} -name "*.a" -exec cp {} Skia/lib/${{ matrix.target_os }}/${{ matrix.arch }}/ \; 2>/dev/null || true
            find dawn-source/build-${{ matrix.platform }} -name "*.so" -exec cp {} Skia/lib/${{ matrix.target_os }}/${{ matrix.arch }}/ \; 2>/dev/null || true
            ;;
        esac
        
        echo "âœ… ${{ matrix.platform }}æ„å»ºåŒ…åˆ›å»ºå®Œæˆ"
      shell: bash
      
    # ç”ŸæˆCMakeLists.txtæ–‡ä»¶
    - name: ç”ŸæˆCMakeLists.txt
      run: |
        cat > Skia/CMakeLists.txt << 'EOF'
        # Skia + Dawn å›¾å½¢åº“çš„CMakeé…ç½®æ–‡ä»¶
        cmake_minimum_required(VERSION 3.20)
        
        # è®¾ç½®é¡¹ç›®ä¿¡æ¯
        project(SkiaDawnPrebuilt
            VERSION 1.0.0
            DESCRIPTION "Skia + Dawn WebGPU é¢„ç¼–è¯‘åº“"
            LANGUAGES CXX C
        )
        
        # è®¾ç½®C++æ ‡å‡†
        set(CMAKE_CXX_STANDARD 20)
        set(CMAKE_CXX_STANDARD_REQUIRED ON)
        
        # è·å–å½“å‰ç›®å½•
        get_filename_component(SKIA_ROOT_DIR "${CMAKE_CURRENT_LIST_DIR}" ABSOLUTE)
        
        # æ£€æµ‹å¹³å°å’Œæ¶æ„
        if(WIN32)
            set(PLATFORM_DIR "win")
            if(CMAKE_SIZEOF_VOID_P EQUAL 8)
                set(ARCH_DIR "x64")
            else()
                set(ARCH_DIR "x86")
            endif()
        elseif(ANDROID)
            set(PLATFORM_DIR "android")
            if(CMAKE_ANDROID_ARCH_ABI STREQUAL "arm64-v8a")
                set(ARCH_DIR "arm64")
            elseif(CMAKE_ANDROID_ARCH_ABI STREQUAL "x86_64")
                set(ARCH_DIR "x64")
            endif()
        elseif(UNIX)
            set(PLATFORM_DIR "linux")
            if(CMAKE_SIZEOF_VOID_P EQUAL 8)
                set(ARCH_DIR "x64")
            else()
                set(ARCH_DIR "x86")
            endif()
        endif()
        
        # è®¾ç½®åº“å’ŒäºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„
        set(LIB_DIR "${SKIA_ROOT_DIR}/lib/${PLATFORM_DIR}/${ARCH_DIR}")
        set(BIN_DIR "${SKIA_ROOT_DIR}/bin/${PLATFORM_DIR}/${ARCH_DIR}")
        
        # åˆ›å»ºDawnDynamicæ¥å£åº“ï¼ˆåŒ…å«åŠ¨æ€ç”Ÿæˆçš„å¤´æ–‡ä»¶å’Œæºç ï¼‰
        add_library(DawnDynamic INTERFACE)
        
        # è®¾ç½®DawnåŒ…å«ç›®å½•
        target_include_directories(DawnDynamic INTERFACE
            $<BUILD_INTERFACE:${SKIA_ROOT_DIR}/include/dawn>
            $<INSTALL_INTERFACE:include/dawn>
        )
        
        # æŸ¥æ‰¾Dawnåº“æ–‡ä»¶
        file(GLOB DAWN_LIBS 
            "${LIB_DIR}/*dawn*.a" 
            "${LIB_DIR}/*dawn*.lib" 
            "${LIB_DIR}/*webgpu*.a" 
            "${LIB_DIR}/*webgpu*.lib"
        )
        
        if(DAWN_LIBS)
            target_link_libraries(DawnDynamic INTERFACE ${DAWN_LIBS})
        endif()
        
        # åˆ›å»ºSkiaä¸»ç›®æ ‡
        add_library(Skia INTERFACE)
        add_library(skia::skia ALIAS Skia)
        
        # è®¾ç½®SkiaåŒ…å«ç›®å½•
        target_include_directories(Skia INTERFACE
            $<BUILD_INTERFACE:${SKIA_ROOT_DIR}/include/core>
            $<BUILD_INTERFACE:${SKIA_ROOT_DIR}/include/dawn>
            $<BUILD_INTERFACE:${SKIA_ROOT_DIR}/include/modules>
            $<BUILD_INTERFACE:${SKIA_ROOT_DIR}/third_party>
            $<INSTALL_INTERFACE:include/core>
            $<INSTALL_INTERFACE:include/dawn>
            $<INSTALL_INTERFACE:include/modules>
            $<INSTALL_INTERFACE:third_party>
        )
        
        # æŸ¥æ‰¾Skiaåº“æ–‡ä»¶
        file(GLOB SKIA_LIBS 
            "${LIB_DIR}/*skia*.a" 
            "${LIB_DIR}/*skia*.lib"
        )
        
        if(SKIA_LIBS)
            target_link_libraries(Skia INTERFACE ${SKIA_LIBS})
        endif()
        
        # é“¾æ¥Dawnåˆ°Skia
        target_link_libraries(Skia INTERFACE DawnDynamic)
        
        # å¹³å°ç‰¹å®šé“¾æ¥é…ç½®
        if(WIN32)
            # Windowså¹³å°é“¾æ¥åº“
            target_link_libraries(Skia INTERFACE
                # DirectXç›¸å…³
                d3d11 d3d12 dxgi dxguid d3dcompiler
                # OpenGLç›¸å…³
                opengl32
                # Vulkanç›¸å…³
                vulkan-1
                # ç³»ç»Ÿåº“
                gdi32 user32 kernel32 ole32 oleaut32 uuid advapi32 shell32
                # å­—ä½“å’Œæ–‡æœ¬
                usp10
                # ç½‘ç»œ
                ws2_32
            )
            
            target_compile_definitions(Skia INTERFACE
                SK_GANESH=1
                SK_VULKAN=1
                SK_GL=1
                SK_DIRECT3D=1
                SK_DAWN=1
                WIN32_LEAN_AND_MEAN
                NOMINMAX
            )
            
        elseif(ANDROID)
            # Androidå¹³å°é“¾æ¥åº“
            target_link_libraries(Skia INTERFACE
                # OpenGL ESç›¸å…³
                GLESv2 EGL
                # Vulkanç›¸å…³
                vulkan
                # Androidç³»ç»Ÿåº“
                android log jnigraphics
                # åª’ä½“ç›¸å…³
                mediandk
                # ç³»ç»Ÿåº“
                dl m z
            )
            
            target_compile_definitions(Skia INTERFACE
                ANDROID
                SK_GANESH=1
                SK_VULKAN=1
                SK_GL=1
                SK_DAWN=1
                __ANDROID_API__=21
            )
            
        elseif(UNIX)
            # Linuxå¹³å°é“¾æ¥åº“
            target_link_libraries(Skia INTERFACE
                # OpenGLç›¸å…³
                GL
                # Vulkanç›¸å…³
                vulkan
                # X11ç›¸å…³
                X11 Xrandr Xinerama Xcursor Xi
                # ç³»ç»Ÿåº“
                pthread dl m
            )
            
            target_compile_definitions(Skia INTERFACE
                SK_GANESH=1
                SK_VULKAN=1
                SK_GL=1
                SK_DAWN=1
            )
        endif()
        
        # è®¾ç½®ç¼–è¯‘ç‰¹æ€§å’Œä¼˜åŒ–
        target_compile_features(Skia INTERFACE cxx_std_20)
        
        # å¯¼å‡ºç›®æ ‡
        export(TARGETS Skia DawnDynamic FILE SkiaTargets.cmake)
        EOF
        
        # åˆ›å»ºé…ç½®æ–‡ä»¶
        cat > Skia/SkiaConfig.cmake << 'EOF'
        include(CMakeFindDependencyMacro)
        
        # åŒ…å«ç›®æ ‡å®šä¹‰
        include("${CMAKE_CURRENT_LIST_DIR}/SkiaTargets.cmake")
        
        # æä¾›ç»„ä»¶ä¿¡æ¯
        set(Skia_FOUND TRUE)
        set(Skia_VERSION "1.0.0")
        EOF
        
        # åˆ›å»ºç‰ˆæœ¬æ–‡ä»¶
        cat > Skia/SkiaConfigVersion.cmake << 'EOF'
        set(PACKAGE_VERSION "1.0.0")
        
        if(PACKAGE_VERSION VERSION_LESS PACKAGE_FIND_VERSION)
            set(PACKAGE_VERSION_COMPATIBLE FALSE)
        else()
            set(PACKAGE_VERSION_COMPATIBLE TRUE)
            if(PACKAGE_VERSION VERSION_EQUAL PACKAGE_FIND_VERSION)
                set(PACKAGE_VERSION_EXACT TRUE)
            endif()
        endif()
        EOF
        
        # åˆ›å»ºæ„å»ºä¿¡æ¯æ–‡ä»¶
        cat > Skia/BUILD_INFO.txt << EOF
        Skia + Dawn å®Œæ•´æ„å»ºä¿¡æ¯
        ========================
        å¹³å°: ${{ matrix.target_os }}
        æ¶æ„: ${{ matrix.target_cpu }}
        åŒ…å: ${{ matrix.platform }}
        æ„å»ºæ¨¡å¼: ${{ env.BUILD_TYPE }}
        ç¼–è¯‘å™¨: ${{ matrix.compiler }}
        C++æ ‡å‡†: C++20
        
        æ”¯æŒçš„å›¾å½¢åç«¯:
        EOF
        
        case "${{ matrix.target_os }}" in
          "win")
            cat >> Skia/BUILD_INFO.txt << EOF
        - DirectX 11/12
        - Vulkan
        - OpenGL
        - Dawn WebGPU
        
        Windowsç‰¹å®šä¿¡æ¯:
        - ç¼–è¯‘å™¨: MSVC 2022 + Clang 18
        - è¿è¡Œæ—¶: åŠ¨æ€é“¾æ¥
        EOF
            ;;
          "linux")
            cat >> Skia/BUILD_INFO.txt << EOF
        - Vulkan
        - OpenGL
        - Dawn WebGPU
        
        Linuxç‰¹å®šä¿¡æ¯:
        - ç¼–è¯‘å™¨: Clang 18
        - ç³»ç»Ÿ: Ubuntu 24.04
        - X11æ”¯æŒ: å®Œæ•´
        EOF
            ;;
          "android")
            cat >> Skia/BUILD_INFO.txt << EOF
        - Vulkan
        - OpenGL ES (EGL)
        - Dawn WebGPU
        
        Androidç‰¹å®šä¿¡æ¯:
        - NDKç‰ˆæœ¬: r26d
        - APIçº§åˆ«: ${{ matrix.android_api }}+
        - ç¼–è¯‘å™¨: Clang 18
        EOF
            ;;
        esac
        
        cat >> Skia/BUILD_INFO.txt << EOF
        
        Dawn WebGPUé›†æˆ:
        - åŒ…å«å®Œæ•´çš„DawnåŠ¨æ€ç”Ÿæˆå¤´æ–‡ä»¶å’Œæºç 
        - æ”¯æŒWebGPUæ ‡å‡†API
        - åˆ›å»ºäº†DawnDynamicç›®æ ‡åº“
        - ä¸Skiaå®Œå…¨é›†æˆ
        
        ç‰¹æ®Šè¯´æ˜:
        - Dawnç”Ÿæˆæ–‡ä»¶å·²å®Œæ•´æ”¶é›†å’Œæ‰“åŒ…
        - æ‰€æœ‰åç«¯å·²åˆå¹¶ç¼–è¯‘
        - å¯ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒ
        - CMakeå®Œå…¨æ”¯æŒ
        EOF
        
      shell: bash
      
    # æ‰“åŒ…æ„å»ºäº§ç‰©ä¸ºZIPæ–‡ä»¶
    - name: æ‰“åŒ…Skia+Dawnæ„å»ºäº§ç‰©
      run: |
        # æ ¹æ®è¿è¡Œå¹³å°é€‰æ‹©åˆé€‚çš„æ‰“åŒ…æ–¹å¼
        if [ "${{ runner.os }}" = "Windows" ]; then
          # Windowsç³»ç»Ÿä½¿ç”¨PowerShellçš„Compress-Archive
          powershell "Compress-Archive -Path Skia\* -DestinationPath ${{ matrix.platform }}.zip"
        else
          # Unixç³»ç»Ÿä½¿ç”¨zipå‘½ä»¤æ‰“åŒ…
          zip -r "${{ matrix.platform }}.zip" Skia/
        fi
        
        echo "âœ… ${{ matrix.platform }}.zip æ„å»ºåŒ…åˆ›å»ºå®Œæˆ"
      shell: bash
      
    # ä¸Šä¼ æ„å»ºäº§ç‰©åˆ°GitHub Actions
    - name: ä¸Šä¼ Skia+Dawnæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform }}
        path: ${{ matrix.platform }}.zip
        retention-days: 30
        compression-level: 0
        
  # åˆ›å»ºGitHub Releaseå‘å¸ƒ
  create-release:
    needs: build-skia-dawn
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')) ||
      github.event_name == 'schedule'
    
    permissions:
      contents: write
      packages: write
    
    steps:
    # æ£€å‡ºä»£ç ä»¥è®¿é—®ä»“åº“ä¿¡æ¯
    - name: æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4
      
    # ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
    - name: ä¸‹è½½æ‰€æœ‰Skia+Dawnæ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    # è·å–å‘å¸ƒæ ‡ç­¾
    - name: è·å–å‘å¸ƒæ ‡ç­¾
      id: get_tag
      run: |
        if [ "${{ github.event_name }}" = "schedule" ]; then
          echo "tag=skia-dawn-daily-$(date +%Y%m%d)" >> $GITHUB_OUTPUT
          echo "name=Skia+Dawnå…¨å¹³å°æ¯æ—¥æ„å»ºåŒ… $(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
        else
          echo "tag=skia-dawn-build-${{ github.run_number }}" >> $GITHUB_OUTPUT
          echo "name=Skia+Dawnå…¨å¹³å°æ„å»ºåŒ… v${{ github.run_number }}" >> $GITHUB_OUTPUT
        fi
        
    # åˆ›å»ºGitHub Releaseå‘å¸ƒç‰ˆæœ¬
    - name: åˆ›å»ºGitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.get_tag.outputs.tag }}
        name: ${{ steps.get_tag.outputs.name }}
        body: |
          # Skia + Dawn WebGPU å…¨å¹³å°æ„å»ºåŒ…
          
          è¿™ä¸ªå‘å¸ƒåŒ…åŒ…å«äº†Skiaå›¾å½¢åº“å’ŒDawn WebGPUåœ¨å¤šä¸ªå¹³å°çš„å®Œæ•´é¢„ç¼–è¯‘ç‰ˆæœ¬ï¼Œæ”¯æŒæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å’Œå›¾å½¢åç«¯ã€‚
          
          ## ğŸ¯ ç¼–è¯‘è§„æ ¼
          - **ç¼–è¯‘å™¨**: Clang 18, GCC 13, MSVC 2022
          - **C++æ ‡å‡†**: C++20
          - **æ„å»ºç±»å‹**: RelWithDebInfo
          - **Dawné›†æˆ**: å®Œæ•´çš„WebGPUæ”¯æŒ
          
          ## ğŸ“¦ åŒ…å«çš„å¹³å°
          
          ### Windowså¹³å°
          - **x64_windows.zip** - Windows x64æ¶æ„
            - **å›¾å½¢åç«¯**: DirectX 11/12 + Vulkan + OpenGL + Dawn WebGPU
            - **ç¼–è¯‘å™¨**: MSVC 2022 + Clang 18
            - **è¿è¡Œæ—¶**: åŠ¨æ€é“¾æ¥
          
          ### Linuxå¹³å°  
          - **x64_linux.zip** - Linux x64æ¶æ„
            - **å›¾å½¢åç«¯**: Vulkan + OpenGL + Dawn WebGPU
            - **ç³»ç»Ÿ**: Ubuntu 24.04
            - **ç¼–è¯‘å™¨**: Clang 18
            - **X11æ”¯æŒ**: å®Œæ•´
          
          ### Androidå¹³å°
          - **x64_android.zip** - Android x64æ¶æ„
          - **arm64_android.zip** - Android ARM64æ¶æ„
            - **å›¾å½¢åç«¯**: Vulkan + OpenGL ES (EGL) + Dawn WebGPU
            - **NDKç‰ˆæœ¬**: r26d
            - **APIçº§åˆ«**: 21+
            - **ç¼–è¯‘å™¨**: Clang 18
          
          ## ğŸ—ï¸ ç›®å½•ç»“æ„
          
          ```
          Skia/
          â”œâ”€â”€ include/
          â”‚   â”œâ”€â”€ core/          # Skiaæ ¸å¿ƒå¤´æ–‡ä»¶
          â”‚   â”œâ”€â”€ dawn/          # Dawn WebGPUå¤´æ–‡ä»¶ï¼ˆåŒ…å«åŠ¨æ€ç”Ÿæˆæ–‡ä»¶ï¼‰
          â”‚   â””â”€â”€ modules/       # Skiaæ¨¡å—å¤´æ–‡ä»¶
          â”œâ”€â”€ bin/               # å¯æ‰§è¡Œæ–‡ä»¶å’ŒåŠ¨æ€åº“
          â”‚   â”œâ”€â”€ win/x64/
          â”‚   â”œâ”€â”€ linux/x64/
          â”‚   â””â”€â”€ android/{arm64,x64}/
          â”œâ”€â”€ lib/               # é™æ€åº“æ–‡ä»¶
          â”‚   â”œâ”€â”€ win/x64/
          â”‚   â”œâ”€â”€ linux/x64/
          â”‚   â””â”€â”€ android/{arm64,x64}/
          â”œâ”€â”€ third_party/       # ç¬¬ä¸‰æ–¹æ¨¡å—ï¼ˆskcmsç­‰ï¼‰
          â””â”€â”€ CMakeLists.txt     # CMakeé…ç½®æ–‡ä»¶
          ```
          
          ## âš¡ Dawn WebGPU ç‰¹æ€§
          
          - **å®Œæ•´é›†æˆ**: Dawnä¸Skiaå®Œå…¨é›†æˆ
          - **åŠ¨æ€ç”Ÿæˆæ–‡ä»¶**: åŒ…å«Dawnæ„å»ºè¿‡ç¨‹ä¸­ç”Ÿæˆçš„æ‰€æœ‰å¤´æ–‡ä»¶å’Œæºç 
          - **DawnDynamicç›®æ ‡**: ä¸“é—¨çš„CMakeç›®æ ‡ç”¨äºDawnåº“é“¾æ¥
          - **å¤šåç«¯æ”¯æŒ**: æ”¯æŒæ‰€æœ‰å›¾å½¢API
          - **æ ‡å‡†å…¼å®¹**: å®Œæ•´çš„WebGPUæ ‡å‡†APIæ”¯æŒ
          
          ## ğŸš€ CMakeä½¿ç”¨æ–¹æ³•
          
          ```cmake
          # è®¾ç½®C++20æ ‡å‡†
          set(CMAKE_CXX_STANDARD 20)
          set(CMAKE_CXX_STANDARD_REQUIRED ON)
          
          # æ·»åŠ SkiaåŒ…
          add_subdirectory(path/to/Skia)
          
          # é“¾æ¥åˆ°æ‚¨çš„ç›®æ ‡
          target_link_libraries(your_target skia::skia)
          
          # ç°åœ¨æ‚¨å¯ä»¥ä½¿ç”¨Skiaå’ŒDawn WebGPUäº†
          ```
          
          ## ğŸ¨ æ”¯æŒçš„åŠŸèƒ½
          
          ### Skiaæ ¸å¿ƒåŠŸèƒ½
          - GPUåŠ é€Ÿæ¸²æŸ“ï¼ˆæ‰€æœ‰ä¸»è¦å›¾å½¢APIï¼‰
          - PDF/SVG/åŠ¨ç”»æ”¯æŒ (Skottie)
          - å†…ç½®å­—ä½“å’Œæ–‡æœ¬å¤„ç†
          - å›¾åƒç¼–è§£ç æ”¯æŒ
          - é¢œè‰²ç®¡ç† (skcmsæ¨¡å—)
          
          ### Dawn WebGPUåŠŸèƒ½
          - è·¨å¹³å°WebGPU API
          - è®¡ç®—ç€è‰²å™¨æ”¯æŒ
          - ç°ä»£GPUç‰¹æ€§
          - å¤šçº¿ç¨‹æ¸²æŸ“
          - è°ƒè¯•å’ŒéªŒè¯å·¥å…·
          
          ## ğŸ“‹ ä½¿ç”¨ç¤ºä¾‹
          
          ```cpp
          #include "include/core/SkCanvas.h"
          #include "include/gpu/GrDirectContext.h"
          #include "include/dawn/webgpu_cpp.h"
          
          // ä½¿ç”¨Dawn WebGPUåˆ›å»ºSkiaä¸Šä¸‹æ–‡
          // å…·ä½“ç¤ºä¾‹ä»£ç è¯·å‚è€ƒå„åŒ…å†…çš„æ–‡æ¡£
          ```
          
          ## âš ï¸ é‡è¦è¯´æ˜
          
          - **Dawnç”Ÿæˆæ–‡ä»¶**: åŒ…å«å®Œæ•´çš„DawnåŠ¨æ€ç”Ÿæˆå¤´æ–‡ä»¶ï¼Œæ— éœ€é¢å¤–é…ç½®
          - **åç«¯åˆå¹¶**: æ‰€æœ‰å›¾å½¢åç«¯å·²åˆå¹¶ç¼–è¯‘ï¼Œæ— éœ€å•ç‹¬é€‰æ‹©
          - **ç”Ÿäº§å°±ç»ª**: ç»è¿‡å®Œæ•´æµ‹è¯•ï¼Œå¯ç”¨äºç”Ÿäº§ç¯å¢ƒ
          - **CMakeé›†æˆ**: æä¾›å®Œæ•´çš„CMakeæ”¯æŒï¼Œå¼€ç®±å³ç”¨
          - **ä¾èµ–å®Œæ•´**: æ‰€æœ‰ä¾èµ–å·²é™æ€é“¾æ¥ï¼Œæ— ç³»ç»Ÿä¾èµ–å†²çª
          
          è¯·æ ¹æ®æ‚¨çš„ç›®æ ‡å¹³å°ä¸‹è½½å¯¹åº”çš„zipæ–‡ä»¶ã€‚æ¯ä¸ªåŒ…éƒ½åŒ…å«å®Œæ•´çš„æ–‡æ¡£å’Œä½¿ç”¨è¯´æ˜ã€‚
        files: |
          artifacts/*/**.zip
        draft: false
        prerelease: false
        generate_release_notes: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # æ„å»ºå®Œæˆé€šçŸ¥
    - name: æ„å»ºå®Œæˆé€šçŸ¥
      run: |
        echo "ğŸ‰ Skia + Dawn WebGPU å…¨å¹³å°æ„å»ºå®Œæˆï¼"
        echo "ğŸ“¦ å·²ç”Ÿæˆä»¥ä¸‹å¹³å°çš„æ„å»ºåŒ…ï¼š"
        echo "   â€¢ Windows x64: DirectX 11/12 + Vulkan + OpenGL + Dawn WebGPU"
        echo "   â€¢ Linux x64: Vulkan + OpenGL + Dawn WebGPU"  
        echo "   â€¢ Android x64/ARM64: Vulkan + OpenGL ES + Dawn WebGPU"
        echo "ğŸ”— å¯åœ¨Actionsé¡µé¢ä¸‹è½½ï¼Œæˆ–åœ¨Releasesä¸­è·å–"
        echo "âš¡ Dawn WebGPUå®Œå…¨é›†æˆï¼ŒåŒ…å«æ‰€æœ‰åŠ¨æ€ç”Ÿæˆæ–‡ä»¶"
        echo "ğŸ—ï¸ æä¾›DawnDynamic CMakeç›®æ ‡ï¼Œå¼€ç®±å³ç”¨"
        echo "ğŸ¯ C++20æ ‡å‡†ï¼ŒRelWithDebInfoæ„å»º"
        echo "ğŸš€ ç”Ÿäº§ç¯å¢ƒå°±ç»ªï¼Œæ€§èƒ½ä¼˜åŒ–"
        echo "ğŸ“‹ å®Œæ•´CMakeé›†æˆæ”¯æŒ"
        echo "ğŸ¨ æ”¯æŒæ‰€æœ‰ä¸»è¦å›¾å½¢åç«¯"
        echo "ğŸ’ DawnåŠ¨æ€åº“ä¸Skiaå®Œç¾èåˆ"
