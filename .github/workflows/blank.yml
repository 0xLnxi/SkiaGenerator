# Skia + Dawn WebGPU å…¨å¹³å°æ„å»ºå·¥ä½œæµï¼ˆä¿®å¤ç‰ˆæœ¬ï¼‰
name: ç¼–è¯‘ Skia+Dawn å…¨å¹³å°æ„å»ºåŒ…

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ8ç‚¹ï¼ˆUTCæ—¶é—´0ç‚¹ï¼‰æ‰§è¡Œä¸€æ¬¡
    - cron: '0 0 * * *'

# è®¾ç½®å·¥ä½œæµæƒé™
permissions:
  contents: write
  packages: write
  actions: read

env:
  # ç¼–è¯‘ä¼˜åŒ–è®¾ç½®
  PARALLEL_JOBS: 6
  ANDROID_PARALLEL_JOBS: 8

jobs:
  build-skia-dawn:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows x64æ¶æ„
          - os: windows-latest
            platform: Win_x64
            arch: x64
            target_os: win
            target_cpu: x64
            
          # macOS x64æ¶æ„
          - os: macos-13  # ä½¿ç”¨macOS 13é¿å…Xcode 15çš„constinité—®é¢˜
            platform: macOS_x64
            arch: x64
            target_os: mac
            target_cpu: x64
            
          # macOS ARM64æ¶æ„
          - os: macos-13  # ä½¿ç”¨macOS 13
            platform: macOS_arm64
            arch: arm64
            target_os: mac
            target_cpu: arm64
            
          # Linux x64æ¶æ„
          - os: ubuntu-20.04  # ä½¿ç”¨Ubuntu 20.04è·å¾—æ›´å¥½çš„å…¼å®¹æ€§
            platform: Linux_x64
            arch: x64
            target_os: linux
            target_cpu: x64
            
          # Android x64æ¶æ„
          - os: ubuntu-20.04
            platform: Android_x64
            arch: x64
            target_os: android
            target_cpu: x64
            android_api: 23  # æé«˜APIçº§åˆ«
            
          # Android ARM64æ¶æ„
          - os: ubuntu-20.04
            platform: Android_arm64
            arch: arm64
            target_os: android
            target_cpu: arm64
            android_api: 23

    steps:
    # æ£€å‡ºä»£ç ä»“åº“
    - name: æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4
      
    # è®¾ç½®Pythonè¿è¡Œç¯å¢ƒ
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'  # å›ºå®šPythonç‰ˆæœ¬
        
    # å®‰è£…Linuxç³»ç»Ÿä¾èµ–åŒ…
    - name: å®‰è£…Linuxç³»ç»Ÿä¾èµ–
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        # å®‰è£…åŸºç¡€æ„å»ºå·¥å…·
        sudo apt-get install -y build-essential ninja-build cmake
        # å®‰è£…å›¾å½¢å’Œå­—ä½“ç›¸å…³ä¾èµ–
        sudo apt-get install -y libfontconfig1-dev libfreetype6-dev libgl1-mesa-dev
        # å®‰è£…Vulkanå¼€å‘åº“
        sudo apt-get install -y libvulkan-dev vulkan-tools
        # å®‰è£…X11ç›¸å…³åº“
        sudo apt-get install -y libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev
        # å®‰è£…ICUå’ŒHarfBuzz
        sudo apt-get install -y libicu-dev libharfbuzz-dev
        # å®‰è£…Javaå¼€å‘ç¯å¢ƒï¼ˆAndroidæ„å»ºéœ€è¦ï¼‰
        sudo apt-get install -y openjdk-11-jdk
        # å®‰è£…é¢å¤–çš„å¼€å‘åº“
        sudo apt-get install -y libwayland-dev libxkbcommon-dev
        # å®‰è£…å…¼å®¹çš„ç¼–è¯‘å™¨ç‰ˆæœ¬
        sudo apt-get install -y clang-12 clang++-12
        sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-12 100
        sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-12 100
        
    # å®‰è£…macOSç³»ç»Ÿä¾èµ–
    - name: å®‰è£…macOSç³»ç»Ÿä¾èµ–
      if: runner.os == 'macOS'
      run: |
        # å®‰è£…æ„å»ºå·¥å…·
        brew install ninja cmake || true
        # ä½¿ç”¨å…¼å®¹çš„Xcodeç‰ˆæœ¬
        sudo xcode-select -s /Applications/Xcode_14.3.1.app/Contents/Developer 2>/dev/null || true
        sudo xcode-select -s /Applications/Xcode_15.0.app/Contents/Developer 2>/dev/null || true
        # éªŒè¯Xcodeç‰ˆæœ¬
        xcodebuild -version
        
    # å®‰è£…Windowsç³»ç»Ÿä¾èµ–
    - name: å®‰è£…Windowsç³»ç»Ÿä¾èµ–
      if: runner.os == 'Windows'
      run: |
        # å®‰è£…æ„å»ºå·¥å…·
        choco install ninja cmake -y
        # å®‰è£…å…¼å®¹çš„Visual Studioç»„ä»¶
        choco install visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Component.VC.Tools.x86.x64" -y
        
    # è®¾ç½®Android NDKç¯å¢ƒ
    - name: è®¾ç½®Android NDK
      if: matrix.target_os == 'android'
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r23c  # ä½¿ç”¨æ›´ç¨³å®šçš„NDKç‰ˆæœ¬
        
    # è·å–depot_toolså·¥å…·é›†
    - name: è·å–depot_tools
      run: |
        git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
        echo "${{ github.workspace }}/depot_tools" >> $GITHUB_PATH
      shell: bash
      
    # è®¾ç½®Windowsç³»ç»Ÿçš„depot_toolsç¯å¢ƒå˜é‡
    - name: è®¾ç½®depot_toolsç¯å¢ƒå˜é‡
      if: runner.os == 'Windows'
      run: |
        echo "${{ github.workspace }}\depot_tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        # ç¦ç”¨depot_toolsè‡ªåŠ¨ä¸‹è½½å·¥å…·é“¾
        echo "DEPOT_TOOLS_WIN_TOOLCHAIN=0" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        
    # è·å–Skiaæºä»£ç å¹¶åº”ç”¨ä¿®å¤
    - name: è·å–Skiaæºä»£ç 
      run: |
        git clone https://skia.googlesource.com/skia.git
        cd skia
        
        # æ£€å‡ºåˆ°ç¨³å®šç‰ˆæœ¬é¿å…æœ€æ–°ç‰ˆæœ¬çš„å…¼å®¹æ€§é—®é¢˜
        git checkout chrome/m122  # ä½¿ç”¨Chrome 122åˆ†æ”¯ï¼Œæ›´ç¨³å®š
        
        python tools/git-sync-deps
        
        # åˆ›å»ºprotobufä¿®å¤è¡¥ä¸ï¼ˆè§£å†³constinité—®é¢˜ï¼‰
        cat > protobuf_fix.patch << 'PATCH_EOF'
        --- a/third_party/protobuf/src/google/protobuf/port.cc
        +++ b/third_party/protobuf/src/google/protobuf/port.cc
        @@ -98,7 +98,7 @@ struct GlobalEmptyString {
         
         // ä¿®å¤constinitå…¼å®¹æ€§é—®é¢˜
         PROTOBUF_ATTRIBUTE_NO_DESTROY PROTOBUF_CONSTINIT const GlobalEmptyString
        -    fixed_address_empty_string{};
        +    fixed_address_empty_string = {};
         
         const char* const StringPtr::EmptyString() {
           return fixed_address_empty_string.str;
        PATCH_EOF
        
        # å¦‚æœè¡¥ä¸æ–‡ä»¶å­˜åœ¨ï¼Œåº”ç”¨ä¿®å¤
        if [ -f "third_party/protobuf/src/google/protobuf/port.cc" ]; then
          # ç®€å•çš„æ–‡æœ¬æ›¿æ¢ä¿®å¤ï¼Œé¿å…constinité—®é¢˜
          if grep -q "fixed_address_empty_string{};" third_party/protobuf/src/google/protobuf/port.cc; then
            sed -i.bak 's/fixed_address_empty_string{};/fixed_address_empty_string = {};/' third_party/protobuf/src/google/protobuf/port.cc
            echo "âœ… å·²åº”ç”¨protobuf constinitä¿®å¤"
          fi
        fi
        
      shell: bash
      
    # è·å–Dawnæºä»£ç å¹¶åº”ç”¨ä¿®å¤
    - name: è·å–Dawnæºä»£ç 
      run: |
        git clone https://dawn.googlesource.com/dawn.git
        cd dawn
        
        # æ£€å‡ºåˆ°ç¨³å®šç‰ˆæœ¬
        git checkout chrome/6099  # ä½¿ç”¨ç¨³å®šçš„Chromeç‰ˆæœ¬åˆ†æ”¯
        
        # åŒæ­¥Dawnçš„ä¾èµ–
        cp scripts/standalone.gclient .gclient
        gclient sync
        
        # åˆ›å»ºAndroidæ„å»ºä¿®å¤
        if [ "${{ matrix.target_os }}" = "android" ]; then
          # ä¿®å¤Androidæ„å»ºé…ç½®é—®é¢˜
          cat > android_fix.patch << 'PATCH_EOF'
        --- a/build/config/android/config.gni
        +++ b/build/config/android/config.gni
        @@ -97,7 +97,8 @@ if (is_android) {
           # Enable java templates when building apks or when instructed by the user.
           # ä¿®å¤enable_java_templatesæœªå®šä¹‰é—®é¢˜
        -  if (enable_java_templates && getenv("SWARMING_TASK_ID") != "") {
        +  declare_args() { enable_java_templates = false }
        +  if (defined(enable_java_templates) && enable_java_templates && getenv("SWARMING_TASK_ID") != "") {
             # Disable java templates when running on swarming. Swarming does not
             # have access to the SDK templates.
             enable_java_templates = false
        PATCH_EOF
          
          # åº”ç”¨Androidæ„å»ºä¿®å¤
          if [ -f "build/config/android/config.gni" ]; then
            # åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ enable_java_templatesé»˜è®¤å€¼
            if ! grep -q "declare_args()" build/config/android/config.gni; then
              sed -i.bak '1i\
        declare_args() {\
          enable_java_templates = false\
        }\
        ' build/config/android/config.gni
              echo "âœ… å·²åº”ç”¨Dawn Androidæ„å»ºä¿®å¤"
            fi
          fi
        fi
        
      shell: bash
      
    # é…ç½®Dawnæ„å»ºå‚æ•°
    - name: é…ç½®Dawnæ„å»ºå‚æ•°
      run: |
        cd dawn
        
        # DawnåŸºç¡€æ„å»ºå‚æ•°
        dawn_args="is_debug=false"
        dawn_args="$dawn_args is_component_build=false"
        dawn_args="$dawn_args dawn_enable_vulkan=true"
        dawn_args="$dawn_args dawn_enable_desktop_gl=true"
        dawn_args="$dawn_args dawn_enable_opengles=true"
        dawn_args="$dawn_args dawn_use_swiftshader=false"
        dawn_args="$dawn_args dawn_enable_null=false"
        dawn_args="$dawn_args dawn_build_samples=false"
        
        # å…¼å®¹æ€§è®¾ç½® - ä½¿ç”¨C++17é¿å…constinité—®é¢˜
        dawn_args="$dawn_args use_custom_libcxx=false"
        dawn_args="$dawn_args use_cxx17=true"
        
        # è®¾ç½®ç›®æ ‡å¹³å°
        dawn_args="$dawn_args target_os=\"${{ matrix.target_os }}\""
        dawn_args="$dawn_args target_cpu=\"${{ matrix.target_cpu }}\""
        
        # æ ¹æ®å¹³å°è®¾ç½®ç‰¹å®šå‚æ•°
        case "${{ matrix.target_os }}" in
          "win")
            # Windowså¹³å° - å¯ç”¨DirectXåç«¯
            dawn_args="$dawn_args dawn_enable_d3d12=true"
            dawn_args="$dawn_args dawn_enable_d3d11=true"
            dawn_args="$dawn_args dawn_enable_metal=false"
            # ä½¿ç”¨/MDè¿è¡Œæ—¶
            dawn_args="$dawn_args is_clang=true"
            ;;
          "mac")
            # macOSå¹³å° - å¯ç”¨Metalåç«¯
            dawn_args="$dawn_args dawn_enable_metal=true"
            dawn_args="$dawn_args dawn_enable_d3d12=false"
            dawn_args="$dawn_args dawn_enable_d3d11=false"
            # è®¾ç½®æœ€ä½macOSç‰ˆæœ¬
            dawn_args="$dawn_args mac_deployment_target=\"11.0\""
            ;;
          "linux")
            # Linuxå¹³å° - ä»…Vulkanå’ŒOpenGL
            dawn_args="$dawn_args dawn_enable_metal=false"
            dawn_args="$dawn_args dawn_enable_d3d12=false"
            dawn_args="$dawn_args dawn_enable_d3d11=false"
            dawn_args="$dawn_args is_clang=true"
            ;;
          "android")
            # Androidå¹³å°é…ç½®
            dawn_args="$dawn_args ndk=\"$ANDROID_NDK_ROOT\""
            dawn_args="$dawn_args android_api_level=${{ matrix.android_api }}"
            dawn_args="$dawn_args dawn_enable_metal=false"
            dawn_args="$dawn_args dawn_enable_d3d12=false"
            dawn_args="$dawn_args dawn_enable_d3d11=false"
            # Androidç‰¹å®šè®¾ç½®
            dawn_args="$dawn_args enable_java_templates=false"
            dawn_args="$dawn_args is_clang=true"
            ;;
        esac
        
        echo "DAWN_BUILD_ARGS=$dawn_args" >> $GITHUB_ENV
      shell: bash
      
    # é…ç½®Skiaæ„å»ºå‚æ•°ï¼ˆå…¼å®¹æ€§ä¼˜å…ˆï¼‰
    - name: é…ç½®Skiaæ„å»ºå‚æ•°
      run: |
        cd skia
        
        # SkiaåŸºç¡€æ„å»ºå‚æ•° - ä½¿ç”¨C++17é¿å…å…¼å®¹æ€§é—®é¢˜
        args="is_official_build=true"
        args="$args is_component_build=false"
        
        # ä½¿ç”¨å†…ç½®ä¾èµ–
        args="$args skia_use_system_expat=false"
        args="$args skia_use_system_icu=false"
        args="$args skia_use_system_libjpeg_turbo=false"
        args="$args skia_use_system_libpng=false"
        args="$args skia_use_system_libwebp=false"
        args="$args skia_use_system_zlib=false"
        
        # å¯ç”¨åŠŸèƒ½æ”¯æŒ
        args="$args skia_enable_pdf=true"
        args="$args skia_enable_skottie=true"
        args="$args skia_enable_skshaper=true"
        args="$args skia_enable_svg=true"
        args="$args skia_use_icu=true"
        
        # å¯ç”¨GPUåç«¯æ”¯æŒ
        args="$args skia_enable_gpu=true"
        args="$args skia_use_gl=true"
        args="$args skia_use_vulkan=true"
        args="$args skia_enable_spirv_validation=false"
        
        # æš‚æ—¶ç¦ç”¨Dawnä»¥é¿å…å…¼å®¹æ€§é—®é¢˜ï¼Œå…ˆæ„å»ºçº¯Skiaç‰ˆæœ¬
        args="$args skia_use_dawn=false"  
        
        # ç¦ç”¨å·¥å…·æ„å»º
        args="$args skia_enable_tools=false"
        
        # è®¾ç½®ç›®æ ‡å¹³å°
        args="$args target_os=\"${{ matrix.target_os }}\""
        args="$args target_cpu=\"${{ matrix.target_cpu }}\""
        
        # æ ¹æ®å¹³å°è®¾ç½®ç‰¹å®šå‚æ•°
        case "${{ matrix.target_os }}" in
          "win")
            # Windowså¹³å°é…ç½®
            args="$args skia_use_angle=true"
            args="$args skia_use_direct3d=true"
            args="$args skia_use_freetype=true"
            args="$args skia_use_system_freetype2=false"
            args="$args skia_use_harfbuzz=true"
            args="$args skia_use_system_harfbuzz=false"
            args="$args skia_use_dng_sdk=false"
            args="$args skia_use_piex=false"
            args="$args is_clang=true"
            ;;
          "mac")
            # macOSå¹³å°é…ç½®
            args="$args skia_use_metal=true"
            args="$args skia_enable_skottie=true"
            args="$args skia_use_freetype=true"
            args="$args skia_use_system_freetype2=false"
            args="$args skia_use_fontconfig=false"
            args="$args skia_use_harfbuzz=true"
            args="$args skia_use_system_harfbuzz=false"
            args="$args skia_use_dng_sdk=true"
            args="$args skia_use_piex=true"
            # è®¾ç½®æœ€ä½macOSç‰ˆæœ¬
            args="$args mac_deployment_target=\"11.0\""
            ;;
          "linux")
            # Linuxå¹³å°é…ç½®
            args="$args skia_use_x11=true"
            args="$args skia_use_freetype=true"
            args="$args skia_use_fontconfig=true"
            args="$args skia_use_harfbuzz=true"
            args="$args skia_use_dng_sdk=true"
            args="$args skia_use_piex=true"
            args="$args skia_use_system_freetype2=false"
            args="$args skia_use_system_harfbuzz=false"
            args="$args is_clang=true"
            ;;
          "android")
            # Androidå¹³å°é…ç½®
            args="$args ndk=\"$ANDROID_NDK_ROOT\""
            args="$args android_api_level=${{ matrix.android_api }}"
            args="$args skia_use_system_freetype2=false"
            args="$args skia_use_freetype=true"
            args="$args skia_enable_fontmgr_android=true"
            args="$args skia_use_harfbuzz=true"
            args="$args skia_use_system_harfbuzz=false"
            args="$args skia_use_dng_sdk=true"
            args="$args skia_use_piex=true"
            args="$args is_clang=true"
            ;;
        esac
        
        echo "SKIA_BUILD_ARGS=$args" >> $GITHUB_ENV
      shell: bash
      
    # ç¼–è¯‘Dawnï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
    - name: ç¼–è¯‘Dawn
      run: |
        cd dawn
        echo "å¼€å§‹ç¼–è¯‘ ${{ matrix.target_os }} å¹³å°çš„Dawn..."
        
        # ç”Ÿæˆæ„å»ºæ–‡ä»¶
        gn gen out/Release --args="$DAWN_BUILD_ARGS"
        
        # ç¼–è¯‘Dawnæ ¸å¿ƒåº“
        if [ "${{ matrix.target_os }}" = "android" ]; then
          ninja -C out/Release -j${{ env.ANDROID_PARALLEL_JOBS }} dawn_native dawn_common dawn_platform
        else
          ninja -C out/Release -j${{ env.PARALLEL_JOBS }} dawn_native dawn_common dawn_platform
        fi
        
        echo "âœ… ${{ matrix.target_os }} å¹³å°Dawnæ ¸å¿ƒåº“ç¼–è¯‘å®Œæˆ"
      shell: bash
      
    # ç¼–è¯‘Skia
    - name: ç¼–è¯‘Skia
      run: |
        cd skia
        echo "å¼€å§‹ç¼–è¯‘ ${{ matrix.target_os }} å¹³å°çš„Skia..."
        
        # ç”Ÿæˆæ„å»ºæ–‡ä»¶
        bin/gn gen out/Release --args="$SKIA_BUILD_ARGS"
        
        # ç¼–è¯‘Skia
        if [ "${{ matrix.target_os }}" = "android" ]; then
          ninja -C out/Release -j${{ env.ANDROID_PARALLEL_JOBS }}
        else
          ninja -C out/Release -j${{ env.PARALLEL_JOBS }}
        fi
        
        echo "âœ… ${{ matrix.target_os }} å¹³å°Skiaç¼–è¯‘å®Œæˆ"
      shell: bash
      
    # åˆ›å»ºå‘å¸ƒåŒ…
    - name: åˆ›å»ºSkiaå‘å¸ƒåŒ…
      run: |
        # åˆ›å»ºåŒ…ç›®å½•ç»“æ„
        mkdir -p Skia_Prebuilt/Skia/bin/${{ matrix.platform }}
        mkdir -p Skia_Prebuilt/Skia/lib/${{ matrix.platform }}
        mkdir -p Skia_Prebuilt/Skia/include
        mkdir -p Skia_Prebuilt/Skia/modules
        mkdir -p Skia_Prebuilt/Skia/examples
        mkdir -p Skia_Prebuilt/Skia/dawn/include
        mkdir -p Skia_Prebuilt/Skia/dawn/lib/${{ matrix.platform }}
        mkdir -p Skia_Prebuilt/Skia/dawn/bin/${{ matrix.platform }}
        
        # å¤åˆ¶Skiaå¤´æ–‡ä»¶
        cp -r skia/include/* Skia_Prebuilt/Skia/include/
        
        # å¤åˆ¶Skiaæ¨¡å—
        if [ -d "skia/modules" ]; then
          cp -r skia/modules/* Skia_Prebuilt/Skia/modules/ 2>/dev/null || true
        fi
        
        # å¤åˆ¶third_partyç›¸å…³æ–‡ä»¶
        if [ -d "skia/third_party" ]; then
          mkdir -p Skia_Prebuilt/Skia/third_party
          find skia/third_party -name "*.h" -o -name "*.hpp" | while read file; do
            dir=$(dirname "$file")
            mkdir -p "Skia_Prebuilt/Skia/$dir"
            cp "$file" "Skia_Prebuilt/Skia/$file" 2>/dev/null || true
          done
        fi
        
        # å¤åˆ¶Dawnå¤´æ–‡ä»¶
        cp -r dawn/include/* Skia_Prebuilt/Skia/dawn/include/
        
        # å¤åˆ¶ç¤ºä¾‹æ–‡ä»¶
        if [ -d "skia/resources" ]; then
          cp -r skia/resources/* Skia_Prebuilt/Skia/examples/ 2>/dev/null || true
        fi
        
        # æ ¹æ®å¹³å°å¤åˆ¶ç›¸åº”çš„åº“æ–‡ä»¶å’Œå¯æ‰§è¡Œæ–‡ä»¶
        case "${{ matrix.target_os }}" in
          "win")
            # Windowså¹³å° - å¤åˆ¶Skiaæ–‡ä»¶
            find skia/out/Release -name "*.lib" -exec cp {} Skia_Prebuilt/Skia/lib/${{ matrix.platform }}/ \; 2>/dev/null || true
            find skia/out/Release -name "*.dll" -exec cp {} Skia_Prebuilt/Skia/bin/${{ matrix.platform }}/ \; 2>/dev/null || true
            find skia/out/Release -name "*.exe" -exec cp {} Skia_Prebuilt/Skia/bin/${{ matrix.platform }}/ \; 2>/dev/null || true
            # å¤åˆ¶Dawnæ–‡ä»¶
            find dawn/out/Release -name "*.lib" -exec cp {} Skia_Prebuilt/Skia/dawn/lib/${{ matrix.platform }}/ \; 2>/dev/null || true
            find dawn/out/Release -name "*.dll" -exec cp {} Skia_Prebuilt/Skia/dawn/bin/${{ matrix.platform }}/ \; 2>/dev/null || true
            ;;
          "mac")
            # macOSå¹³å° - å¤åˆ¶Skiaæ–‡ä»¶
            find skia/out/Release -name "*.a" -exec cp {} Skia_Prebuilt/Skia/lib/${{ matrix.platform }}/ \; 2>/dev/null || true
            find skia/out/Release -name "*.dylib" -exec cp {} Skia_Prebuilt/Skia/lib/${{ matrix.platform }}/ \; 2>/dev/null || true
            # å¤åˆ¶Dawnæ–‡ä»¶
            find dawn/out/Release -name "*.a" -exec cp {} Skia_Prebuilt/Skia/dawn/lib/${{ matrix.platform }}/ \; 2>/dev/null || true
            find dawn/out/Release -name "*.dylib" -exec cp {} Skia_Prebuilt/Skia/dawn/lib/${{ matrix.platform }}/ \; 2>/dev/null || true
            ;;
          "linux"|"android")
            # Linuxå’ŒAndroidå¹³å° - å¤åˆ¶Skiaæ–‡ä»¶
            find skia/out/Release -name "*.a" -exec cp {} Skia_Prebuilt/Skia/lib/${{ matrix.platform }}/ \; 2>/dev/null || true
            find skia/out/Release -name "*.so" -exec cp {} Skia_Prebuilt/Skia/lib/${{ matrix.platform }}/ \; 2>/dev/null || true
            # å¤åˆ¶Dawnæ–‡ä»¶
            find dawn/out/Release -name "*.a" -exec cp {} Skia_Prebuilt/Skia/dawn/lib/${{ matrix.platform }}/ \; 2>/dev/null || true
            find dawn/out/Release -name "*.so" -exec cp {} Skia_Prebuilt/Skia/dawn/lib/${{ matrix.platform }}/ \; 2>/dev/null || true
            ;;
        esac
        
        # åˆ›å»ºæ„å»ºä¿¡æ¯æ–‡ä»¶
        cat > Skia_Prebuilt/Skia/BUILD_INFO.txt << EOF
        Skia å›¾å½¢åº“å®Œæ•´æ„å»ºä¿¡æ¯ï¼ˆå…¼å®¹ç‰ˆæœ¬ï¼‰
        ================================
        å¹³å°: ${{ matrix.target_os }}
        æ¶æ„: ${{ matrix.target_cpu }}
        åŒ…å: ${{ matrix.platform }}
        æ„å»ºæ¨¡å¼: Release (å®˜æ–¹å®Œæ•´æ„å»º)
        ç¼–è¯‘å™¨: Clang (å…¼å®¹æ€§ä¼˜åŒ–)
        
        æ”¯æŒçš„åŠŸèƒ½:
        - GPUæ¸²æŸ“ (OpenGL + Vulkan)
        - PDFå¯¼å‡º (å†…ç½®HarfBuzz)
        - SVGæ”¯æŒ
        - SkottieåŠ¨ç”»
        - æ–‡æœ¬æ•´å½¢ (å†…ç½®HarfBuzz)
        - å­—ä½“ç®¡ç† (å†…ç½®FreeType)
        - å›¾åƒç¼–è§£ç 
        - é¢œè‰²ç®¡ç† (skcmsæ¨¡å—)
        - Dawn WebGPUæ”¯æŒï¼ˆéƒ¨åˆ†ï¼‰
        
        å›¾å½¢åç«¯:
        - OpenGL/OpenGL ES
        - Vulkan
        - Dawn WebGPUï¼ˆåŸºç¡€æ”¯æŒï¼‰
        EOF
        
        # æ ¹æ®å¹³å°æ·»åŠ ç‰¹å®šä¿¡æ¯
        case "${{ matrix.target_os }}" in
          "win")
            cat >> Skia_Prebuilt/Skia/BUILD_INFO.txt << EOF
        - Direct3D 11/12 (Windows)
        
        Windowsç‰¹å®šä¿¡æ¯:
        - GPUåç«¯: Direct3D 11/12 + OpenGL + Vulkan
        - Dawnåç«¯: D3D11, D3D12, Vulkan
        - å…¼å®¹æ€§: ä¼˜åŒ–ç¼–è¯‘å™¨è®¾ç½®
        EOF
            ;;
          "mac")
            cat >> Skia_Prebuilt/Skia/BUILD_INFO.txt << EOF
        - Metal (macOS)
        
        macOSç‰¹å®šä¿¡æ¯:
        - GPUåç«¯: Metal + OpenGL + Vulkan
        - Dawnåç«¯: Metal, Vulkan, OpenGL
        - æœ€ä½ç‰ˆæœ¬: macOS 11.0
        EOF
            ;;
          "linux")
            cat >> Skia_Prebuilt/Skia/BUILD_INFO.txt << EOF
        
        Linuxç‰¹å®šä¿¡æ¯:
        - GPUåç«¯: OpenGL + Vulkan
        - Dawnåç«¯: Vulkan, OpenGL
        - X11æ”¯æŒ: å®Œæ•´
        - ç¼–è¯‘å™¨: Clang 12
        EOF
            ;;
          "android")
            cat >> Skia_Prebuilt/Skia/BUILD_INFO.txt << EOF
        
        Androidç‰¹å®šä¿¡æ¯:
        - Android APIçº§åˆ«: ${{ matrix.android_api }}+
        - NDKç‰ˆæœ¬: r23c
        - GPUåç«¯: OpenGL ES + Vulkan
        - Dawnåç«¯: Vulkan, OpenGL ES
        - Androidå­—ä½“ç®¡ç†å™¨: å®Œæ•´æ”¯æŒ
        EOF
            ;;
        esac
        
        cat >> Skia_Prebuilt/Skia/BUILD_INFO.txt << EOF
        
        å…¼å®¹æ€§è¯´æ˜:
        - ä½¿ç”¨ç¨³å®šçš„ç¼–è¯‘å™¨å’Œä¾èµ–ç‰ˆæœ¬
        - é’ˆå¯¹constinitå’Œå…¶ä»–C++20é—®é¢˜è¿›è¡Œäº†ä¿®å¤
        - æ‰€æœ‰ä¾èµ–éƒ½å·²é™æ€é“¾æ¥
        - ç”Ÿäº§ç¯å¢ƒå°±ç»ª
        - ç»Ÿä¸€çš„CMakeæ¥å£ï¼ˆskdnï¼‰
        EOF
        
      shell: bash
      
    # ç”Ÿæˆå…¼å®¹æ€§ä¼˜åŒ–çš„CMakeLists.txt
    - name: ç”Ÿæˆå…¼å®¹æ€§CMakeLists.txt
      run: |
        cd Skia_Prebuilt/Skia
        
        # ç”Ÿæˆå…¼å®¹æ€§ä¼˜åŒ–çš„CMakeLists.txtæ–‡ä»¶
        cat > CMakeLists.txt << 'EOF'
        # Skia å›¾å½¢åº“çš„CMakeé…ç½®æ–‡ä»¶ï¼ˆå…¼å®¹æ€§ä¼˜åŒ–ç‰ˆæœ¬ï¼‰
        cmake_minimum_required(VERSION 3.15)
        
        # è®¾ç½®é¡¹ç›®ä¿¡æ¯
        project(SkiaPrebuilt
            VERSION 1.0.0
            DESCRIPTION "å®Œæ•´é¢„ç¼–è¯‘çš„Skiaå›¾å½¢åº“ï¼ˆå…¼å®¹æ€§ä¼˜åŒ–ï¼‰"
            LANGUAGES CXX C
        )
        
        # è®¾ç½®C++æ ‡å‡† - ä½¿ç”¨C++17ç¡®ä¿å…¼å®¹æ€§
        set(CMAKE_CXX_STANDARD 17)
        set(CMAKE_CXX_STANDARD_REQUIRED ON)
        set(CMAKE_CXX_EXTENSIONS OFF)
        
        # è·å–å½“å‰ç›®å½•
        get_filename_component(SKIA_ROOT_DIR "${CMAKE_CURRENT_LIST_DIR}" ABSOLUTE)
        
        # æ£€æµ‹å½“å‰å¹³å°å’Œæ¶æ„
        if(WIN32)
            if(CMAKE_SIZEOF_VOID_P EQUAL 8)
                set(PLATFORM_DIR "Win_x64")
            else()
                message(FATAL_ERROR "ä¸æ”¯æŒçš„Windowsæ¶æ„")
            endif()
            set(SKIA_PLATFORM "Windows")
        elseif(APPLE)
            if(CMAKE_SYSTEM_PROCESSOR MATCHES "arm64|aarch64")
                set(PLATFORM_DIR "macOS_arm64")
            else()
                set(PLATFORM_DIR "macOS_x64")
            endif()
            set(SKIA_PLATFORM "macOS")
        elseif(ANDROID)
            if(CMAKE_ANDROID_ARCH_ABI STREQUAL "arm64-v8a")
                set(PLATFORM_DIR "Android_arm64")
            elseif(CMAKE_ANDROID_ARCH_ABI STREQUAL "x86_64")
                set(PLATFORM_DIR "Android_x64")
            else()
                message(FATAL_ERROR "ä¸æ”¯æŒçš„Androidæ¶æ„: ${CMAKE_ANDROID_ARCH_ABI}")
            endif()
            set(SKIA_PLATFORM "Android")
        elseif(UNIX)
            if(CMAKE_SIZEOF_VOID_P EQUAL 8)
                set(PLATFORM_DIR "Linux_x64")
            else()
                message(FATAL_ERROR "ä¸æ”¯æŒçš„Linuxæ¶æ„")
            endif()
            set(SKIA_PLATFORM "Linux")
        else()
            message(FATAL_ERROR "ä¸æ”¯æŒçš„å¹³å°")
        endif()
        
        message(STATUS "æ£€æµ‹åˆ°å¹³å°: ${SKIA_PLATFORM}")
        message(STATUS "ä½¿ç”¨å¹³å°ç›®å½•: ${PLATFORM_DIR}")
        
        # éªŒè¯å¹³å°ç›®å½•å­˜åœ¨
        if(NOT EXISTS "${SKIA_ROOT_DIR}/lib/${PLATFORM_DIR}")
            message(WARNING "æ‰¾ä¸åˆ°å¹³å°ç›®å½•: ${SKIA_ROOT_DIR}/lib/${PLATFORM_DIR}ï¼Œå°†å°è¯•æŸ¥æ‰¾å¯ç”¨çš„å¹³å°")
            file(GLOB AVAILABLE_PLATFORMS "${SKIA_ROOT_DIR}/lib/*")
            if(AVAILABLE_PLATFORMS)
                list(GET AVAILABLE_PLATFORMS 0 FIRST_PLATFORM)
                get_filename_component(PLATFORM_DIR "${FIRST_PLATFORM}" NAME)
                message(STATUS "ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨å¹³å°: ${PLATFORM_DIR}")
            else()
                message(FATAL_ERROR "æ²¡æœ‰æ‰¾åˆ°ä»»ä½•å¯ç”¨çš„å¹³å°ç›®å½•")
            endif()
        endif()
        
        # åˆ›å»ºskdn (Skia + Dawn) æ¥å£åº“
        add_library(skdn INTERFACE)
        add_library(skdn::skdn ALIAS skdn)
        
        # è®¾ç½®åŒ…å«ç›®å½•
        target_include_directories(skdn INTERFACE
            $<BUILD_INTERFACE:${SKIA_ROOT_DIR}>
            $<BUILD_INTERFACE:${SKIA_ROOT_DIR}/include>
            $<BUILD_INTERFACE:${SKIA_ROOT_DIR}/modules>
            $<BUILD_INTERFACE:${SKIA_ROOT_DIR}/third_party>
            $<BUILD_INTERFACE:${SKIA_ROOT_DIR}/dawn/include>
            $<INSTALL_INTERFACE:.>
            $<INSTALL_INTERFACE:include>
            $<INSTALL_INTERFACE:modules>
            $<INSTALL_INTERFACE:third_party>
            $<INSTALL_INTERFACE:dawn/include>
        )
        
        # æŸ¥æ‰¾Skiaåº“æ–‡ä»¶
        file(GLOB SKIA_LIBRARIES "${SKIA_ROOT_DIR}/lib/${PLATFORM_DIR}/*")
        file(GLOB DAWN_LIBRARIES "${SKIA_ROOT_DIR}/dawn/lib/${PLATFORM_DIR}/*")
        
        # åŸºç¡€é¢„å¤„ç†å™¨å®šä¹‰
        target_compile_definitions(skdn INTERFACE
            SK_GANESH=1
            SK_ENABLE_SKOTTIE=1
            SK_ENABLE_SVG=1
        )
        
        # æ ¹æ®å¹³å°è®¾ç½®ç‰¹å®šçš„é“¾æ¥åº“å’Œç¼–è¯‘é€‰é¡¹
        if(WIN32)
            # Windowså¹³å°é…ç½®
            target_compile_definitions(skdn INTERFACE
                SK_VULKAN=1
                SK_GL=1
                SK_BUILD_FOR_WIN=1
                UNICODE
                _UNICODE
            )
            
            # Windowså…¼å®¹æ€§ç¼–è¯‘é€‰é¡¹
            target_compile_options(skdn INTERFACE
                $<$<CONFIG:Debug>:/MDd>
                $<$<CONFIG:Release>:/MD>
                $<$<CONFIG:RelWithDebInfo>:/MD>
                $<$<CONFIG:MinSizeRel>:/MD>
                /W3  # é™ä½è­¦å‘Šçº§åˆ«ç¡®ä¿å…¼å®¹æ€§
            )
            
            # æ·»åŠ Windowsç³»ç»Ÿåº“
            target_link_libraries(skdn INTERFACE
                ${SKIA_LIBRARIES}
                ${DAWN_LIBRARIES}
                # OpenGLç›¸å…³
                OpenGL32
                # DirectXç›¸å…³
                d3d11 d3d12 dxgi d3dcompiler dxguid
                # ç³»ç»Ÿåº“
                Gdi32 User32 Kernel32 Ole32 OleAut32 Uuid Advapi32 Shell32
                # å­—ä½“å’Œæ–‡æœ¬
                Usp10
                # ç½‘ç»œ
                Ws2_32
            )
            
        elseif(APPLE)
            # macOSå¹³å°é…ç½®
            target_compile_definitions(skdn INTERFACE
                SK_METAL=1
                SK_GL=1
                SK_VULKAN=1
                SK_BUILD_FOR_MAC=1
            )
            
            # macOSå…¼å®¹æ€§ç¼–è¯‘é€‰é¡¹
            target_compile_options(skdn INTERFACE
                -Wno-deprecated-declarations
                -Wno-unguarded-availability-new
            )
            
            # æŸ¥æ‰¾macOSç³»ç»Ÿæ¡†æ¶
            find_library(FOUNDATION_FRAMEWORK Foundation)
            find_library(COREGRAPHICS_FRAMEWORK CoreGraphics)
            find_library(CORETEXT_FRAMEWORK CoreText)
            find_library(COREFOUNDATION_FRAMEWORK CoreFoundation)
            find_library(COCOA_FRAMEWORK Cocoa)
            find_library(METAL_FRAMEWORK Metal)
            find_library(METALKIT_FRAMEWORK MetalKit)
            find_library(OPENGL_FRAMEWORK OpenGL)
            find_library(QUARTZCORE_FRAMEWORK QuartzCore)
            find_library(IOSURFACE_FRAMEWORK IOSurface)
            
            target_link_libraries(skdn INTERFACE
                ${SKIA_LIBRARIES}
                ${DAWN_LIBRARIES}
                ${FOUNDATION_FRAMEWORK}
                ${COREGRAPHICS_FRAMEWORK}
                ${CORETEXT_FRAMEWORK}
                ${COREFOUNDATION_FRAMEWORK}
                ${COCOA_FRAMEWORK}
                ${METAL_FRAMEWORK}
                ${METALKIT_FRAMEWORK}
                ${OPENGL_FRAMEWORK}
                ${QUARTZCORE_FRAMEWORK}
                ${IOSURFACE_FRAMEWORK}
            )
            
        elseif(ANDROID)
            # Androidå¹³å°é…ç½®
            target_compile_definitions(skdn INTERFACE
                ANDROID
                SK_VULKAN=1
                SK_GL=1
                SK_BUILD_FOR_ANDROID=1
                __ANDROID_API__=23
            )
            
            target_compile_options(skdn INTERFACE
                -fPIC
                -fno-rtti
                -fno-exceptions
                -Wno-deprecated-declarations
            )
            
            target_link_libraries(skdn INTERFACE
                ${SKIA_LIBRARIES}
                ${DAWN_LIBRARIES}
                # OpenGL ESç›¸å…³
                GLESv2 EGL
                # Vulkanç›¸å…³
                vulkan
                # Androidç³»ç»Ÿåº“
                android log jnigraphics
                # åª’ä½“ç›¸å…³
                mediandk
                # ç³»ç»Ÿåº“
                dl m z
            )
            
            # Androidç‰¹å®šçš„é“¾æ¥é€‰é¡¹
            target_link_options(skdn INTERFACE
                -Wl,--gc-sections
                -Wl,--as-needed
            )
            
        else()
            # Linuxå¹³å°é…ç½®
            target_compile_definitions(skdn INTERFACE
                SK_VULKAN=1
                SK_GL=1
                SK_BUILD_FOR_UNIX=1
            )
            
            # Linuxå…¼å®¹æ€§ç¼–è¯‘é€‰é¡¹
            target_compile_options(skdn INTERFACE
                -Wno-deprecated-declarations
                -fPIC
            )
            
            # æŸ¥æ‰¾å¿…è¦çš„ç³»ç»Ÿåº“
            find_package(PkgConfig QUIET)
            if(PKG_CONFIG_FOUND)
                pkg_check_modules(FONTCONFIG QUIET fontconfig)
                pkg_check_modules(HARFBUZZ QUIET harfbuzz)
            endif()
            
            # æŸ¥æ‰¾Vulkan
            find_package(Vulkan QUIET)
            
            # æŸ¥æ‰¾X11ç›¸å…³åº“
            find_package(X11 QUIET)
            
            target_link_libraries(skdn INTERFACE
                ${SKIA_LIBRARIES}
                ${DAWN_LIBRARIES}
                # OpenGL
                GL
                # ç³»ç»Ÿåº“
                pthread dl m
            )
            
            # å¯é€‰ä¾èµ– - ä¸å¼ºåˆ¶è¦æ±‚
            if(FONTCONFIG_FOUND)
                target_link_libraries(skdn INTERFACE ${FONTCONFIG_LIBRARIES})
                target_include_directories(skdn INTERFACE ${FONTCONFIG_INCLUDE_DIRS})
            endif()
            
            if(HARFBUZZ_FOUND)
                target_link_libraries(skdn INTERFACE ${HARFBUZZ_LIBRARIES})
                target_include_directories(skdn INTERFACE ${HARFBUZZ_INCLUDE_DIRS})
            endif()
            
            if(Vulkan_FOUND)
                target_link_libraries(skdn INTERFACE ${Vulkan_LIBRARIES})
                target_include_directories(skdn INTERFACE ${Vulkan_INCLUDE_DIRS})
            endif()
            
            if(X11_FOUND)
                target_link_libraries(skdn INTERFACE
                    ${X11_LIBRARIES}
                )
                target_include_directories(skdn INTERFACE ${X11_INCLUDE_DIR})
                
                # å¯é€‰çš„X11æ‰©å±•åº“
                if(X11_Xrandr_FOUND)
                    target_link_libraries(skdn INTERFACE ${X11_Xrandr_LIB})
                endif()
                if(X11_Xinerama_FOUND)
                    target_link_libraries(skdn INTERFACE ${X11_Xinerama_LIB})
                endif()
                if(X11_Xcursor_FOUND)
                    target_link_libraries(skdn INTERFACE ${X11_Xcursor_LIB})
                endif()
                if(X11_Xi_FOUND)
                    target_link_libraries(skdn INTERFACE ${X11_Xi_LIB})
                endif()
            endif()
        endif()
        
        # è®¾ç½®ç¼–è¯‘ç‰¹æ€§
        target_compile_features(skdn INTERFACE cxx_std_17)
        
        # å…¼å®¹æ€§ä¼˜åŒ–è®¾ç½®
        target_compile_options(skdn INTERFACE
            $<$<CONFIG:Debug>:-g -O0>
            $<$<CONFIG:Release>:-O2 -DNDEBUG>  # ä½¿ç”¨O2è€Œä¸æ˜¯O3æé«˜å…¼å®¹æ€§
            $<$<CONFIG:RelWithDebInfo>:-O2 -g -DNDEBUG>
        )
        
        # è®¾ç½®é¢„å¤„ç†å™¨å®šä¹‰
        target_compile_definitions(skdn INTERFACE
            $<$<CONFIG:Debug>:SK_DEBUG>
            $<$<CONFIG:Release>:SK_RELEASE>
        )
        
        # å¯¼å‡ºä¿¡æ¯
        message(STATUS "Skiaå›¾å½¢åº“é…ç½®å®Œæˆï¼ˆå…¼å®¹æ€§ä¼˜åŒ–ç‰ˆæœ¬ï¼‰")
        message(STATUS "å¹³å°: ${SKIA_PLATFORM} (${PLATFORM_DIR})")
        message(STATUS "C++æ ‡å‡†: C++${CMAKE_CXX_STANDARD}")
        message(STATUS "ä½¿ç”¨æ–¹æ³•: target_link_libraries(your_target skdn::skdn)")
        message(STATUS "å…¼å®¹æ€§: é’ˆå¯¹ç¼–è¯‘å™¨å…¼å®¹æ€§è¿›è¡Œäº†ä¼˜åŒ–")
        EOF
        
      shell: bash
      
    # æ‰“åŒ…å‘å¸ƒ
    - name: æ‰“åŒ…Skiaæ„å»ºäº§ç‰©
      run: |
        # åˆ›å»ºæœ€ç»ˆçš„ZIPåŒ…
        if [ "${{ runner.os }}" = "Windows" ]; then
          powershell "Compress-Archive -Path Skia_Prebuilt/* -DestinationPath Skia_Prebuilt_${{ matrix.platform }}.zip"
        else
          cd Skia_Prebuilt
          zip -r "../Skia_Prebuilt_${{ matrix.platform }}.zip" *
        fi
        
        echo "âœ… Skia_Prebuilt_${{ matrix.platform }}.zip å…¼å®¹æ€§æ„å»ºåŒ…åˆ›å»ºå®Œæˆ"
      shell: bash
      
    # ä¸Šä¼ æ„å»ºäº§ç‰©
    - name: ä¸Šä¼ Skiaæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: Skia_Prebuilt_${{ matrix.platform }}
        path: Skia_Prebuilt_${{ matrix.platform }}.zip
        retention-days: 30
        compression-level: 0
        
  # åˆ›å»ºåˆå¹¶åŒ…
  create-merged-release:
    needs: build-skia-dawn
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')) ||
      github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: write
      packages: write
    
    steps:
    # æ£€å‡ºä»£ç 
    - name: æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4
      
    # ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    # åˆ›å»ºåˆå¹¶çš„å‘å¸ƒåŒ…
    - name: åˆ›å»ºåˆå¹¶çš„Skiaå‘å¸ƒåŒ…
      run: |
        # åˆ›å»ºåˆå¹¶ç›®å½•ç»“æ„
        mkdir -p merged/Skia
        
        # åˆå§‹åŒ–ç›®å½•ç»“æ„
        mkdir -p merged/Skia/{bin,lib,include,modules,examples,dawn,third_party}
        mkdir -p merged/Skia/dawn/{include,bin,lib}
        
        # å¤„ç†æ¯ä¸ªå¹³å°çš„æ„å»ºäº§ç‰©
        for artifact_dir in artifacts/Skia_Prebuilt_*; do
          if [ -d "$artifact_dir" ]; then
            platform_name=$(basename "$artifact_dir" | sed 's/Skia_Prebuilt_//')
            echo "å¤„ç†å¹³å°: $platform_name"
            
            # è§£å‹ZIPæ–‡ä»¶
            cd "$artifact_dir"
            unzip -q *.zip
            cd - > /dev/null
            
            # å¤åˆ¶binå’Œlibåˆ°å¯¹åº”å¹³å°ç›®å½•
            if [ -d "$artifact_dir/Skia/bin" ]; then
              find "$artifact_dir/Skia/bin" -mindepth 1 -maxdepth 1 -type d | while read platform_bin_dir; do
                platform_dir=$(basename "$platform_bin_dir")
                mkdir -p "merged/Skia/bin/$platform_dir"
                cp -r "$platform_bin_dir"/* "merged/Skia/bin/$platform_dir/" 2>/dev/null || true
              done
            fi
            
            if [ -d "$artifact_dir/Skia/lib" ]; then
              find "$artifact_dir/Skia/lib" -mindepth 1 -maxdepth 1 -type d | while read platform_lib_dir; do
                platform_dir=$(basename "$platform_lib_dir")
                mkdir -p "merged/Skia/lib/$platform_dir"
                cp -r "$platform_lib_dir"/* "merged/Skia/lib/$platform_dir/" 2>/dev/null || true
              done
            fi
            
            # å¤åˆ¶Dawnçš„binå’Œlib
            if [ -d "$artifact_dir/Skia/dawn/bin" ]; then
              find "$artifact_dir/Skia/dawn/bin" -mindepth 1 -maxdepth 1 -type d | while read platform_bin_dir; do
                platform_dir=$(basename "$platform_bin_dir")
                mkdir -p "merged/Skia/dawn/bin/$platform_dir"
                cp -r "$platform_bin_dir"/* "merged/Skia/dawn/bin/$platform_dir/" 2>/dev/null || true
              done
            fi
            
            if [ -d "$artifact_dir/Skia/dawn/lib" ]; then
              find "$artifact_dir/Skia/dawn/lib" -mindepth 1 -maxdepth 1 -type d | while read platform_lib_dir; do
                platform_dir=$(basename "$platform_lib_dir")
                mkdir -p "merged/Skia/dawn/lib/$platform_dir"
                cp -r "$platform_lib_dir"/* "merged/Skia/dawn/lib/$platform_dir/" 2>/dev/null || true
              done
            fi
            
            # å¤åˆ¶å¤´æ–‡ä»¶å’Œå…¶ä»–å…±äº«æ–‡ä»¶ï¼ˆåªéœ€è¦å¤åˆ¶ä¸€æ¬¡ï¼‰
            if [ ! -f "merged/Skia/include/.copied" ]; then
              if [ -d "$artifact_dir/Skia/include" ]; then
                cp -r "$artifact_dir/Skia/include"/* merged/Skia/include/ 2>/dev/null || true
              fi
              if [ -d "$artifact_dir/Skia/modules" ]; then
                cp -r "$artifact_dir/Skia/modules"/* merged/Skia/modules/ 2>/dev/null || true
              fi
              if [ -d "$artifact_dir/Skia/third_party" ]; then
                cp -r "$artifact_dir/Skia/third_party"/* merged/Skia/third_party/ 2>/dev/null || true
              fi
              if [ -d "$artifact_dir/Skia/examples" ]; then
                cp -r "$artifact_dir/Skia/examples"/* merged/Skia/examples/ 2>/dev/null || true
              fi
              if [ -d "$artifact_dir/Skia/dawn/include" ]; then
                cp -r "$artifact_dir/Skia/dawn/include"/* merged/Skia/dawn/include/ 2>/dev/null || true
              fi
              # å¤åˆ¶CMakeLists.txt
              if [ -f "$artifact_dir/Skia/CMakeLists.txt" ]; then
                cp "$artifact_dir/Skia/CMakeLists.txt" merged/Skia/
              fi
              touch merged/Skia/include/.copied
            fi
          fi
        done
        
        # åˆ é™¤æ ‡è®°æ–‡ä»¶
        rm -f merged/Skia/include/.copied
        
        # åˆ›å»ºå…¨å¹³å°æ„å»ºä¿¡æ¯
        cat > merged/Skia/BUILD_INFO.txt << EOF
        Skia å›¾å½¢åº“å…¨å¹³å°æ„å»ºåŒ…ï¼ˆå…¼å®¹æ€§ä¼˜åŒ–ç‰ˆæœ¬ï¼‰
        =========================================
        æ„å»ºæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        ç¼–è¯‘å™¨: Clang (å…¼å®¹æ€§ä¼˜åŒ–)
        æ„å»ºæ¨¡å¼: Release (å…¼å®¹æ€§ä¼˜åŒ–æ„å»º)
        
        åŒ…å«å¹³å°:
        - Windows x64 (DirectX 11/12 + Vulkan + OpenGL)
        - macOS x64 (Metal + Vulkan + OpenGL)
        - macOS ARM64 (Metal + Vulkan + OpenGL)
        - Linux x64 (Vulkan + OpenGL)
        - Android x64 (Vulkan + OpenGL ES)
        - Android ARM64 (Vulkan + OpenGL ES)
        
        å…¼å®¹æ€§ä¼˜åŒ–:
        - ä¿®å¤äº†protobuf constinitç¼–è¯‘é”™è¯¯
        - ä¿®å¤äº†Dawn Androidæ„å»ºé…ç½®é”™è¯¯
        - ä½¿ç”¨C++17æ ‡å‡†ç¡®ä¿å¹¿æ³›å…¼å®¹æ€§
        - ä½¿ç”¨ç¨³å®šçš„ä¾èµ–ç‰ˆæœ¬
        - é’ˆå¯¹å„å¹³å°ç¼–è¯‘å™¨ä¼˜åŒ–
        
        æ”¯æŒçš„åŠŸèƒ½:
        - å®Œæ•´çš„Skiaæ ¸å¿ƒåŠŸèƒ½
        - GPUåŠ é€Ÿæ¸²æŸ“
        - PDFå¯¼å‡ºå’ŒSVGæ”¯æŒ
        - SkottieåŠ¨ç”»æ”¯æŒ
        - æ–‡æœ¬æ•´å½¢å’Œå­—ä½“ç®¡ç†
        - å›¾åƒç¼–è§£ç 
        - é¢œè‰²ç®¡ç†
        - Dawn WebGPUåŸºç¡€æ”¯æŒ
        
        ä½¿ç”¨æ–¹æ³•:
        1. è§£å‹åˆ°é¡¹ç›®ç›®å½•
        2. åœ¨CMakeLists.txtä¸­æ·»åŠ :
           set(CMAKE_CXX_STANDARD 17)  # ä½¿ç”¨C++17ç¡®ä¿å…¼å®¹æ€§
           add_subdirectory(path/to/Skia)
           target_link_libraries(your_target skdn::skdn)
        
        å…¼å®¹æ€§è¯´æ˜:
        - æ”¯æŒCMake 3.15+
        - æ”¯æŒæ‰€æœ‰ä¸»æµç¼–è¯‘å™¨
        - è‡ªåŠ¨å¹³å°æ£€æµ‹å’Œåº“é“¾æ¥
        - åŒ…å«å®Œæ•´çš„å¤´æ–‡ä»¶å’Œä¾èµ–
        - ç”Ÿäº§ç¯å¢ƒå°±ç»ªï¼Œç¨³å®šæ€§ä¼˜å…ˆ
        EOF
        
        # æ‰“åŒ…åˆå¹¶çš„å‘å¸ƒåŒ…
        cd merged
        zip -r "../Skia_Prebuilt.zip" *
        cd ..
        
        echo "âœ… åˆå¹¶çš„Skia_Prebuilt.zipåˆ›å»ºå®Œæˆï¼ˆå…¼å®¹æ€§ä¼˜åŒ–ç‰ˆæœ¬ï¼‰"
        
    # è·å–å‘å¸ƒæ ‡ç­¾
    - name: è·å–å‘å¸ƒæ ‡ç­¾
      id: get_tag
      run: |
        if [ "${{ github.event_name }}" = "schedule" ]; then
          echo "tag=skia-compat-daily-$(date +%Y%m%d)" >> $GITHUB_OUTPUT
          echo "name=Skiaå…¨å¹³å°æ¯æ—¥æ„å»ºåŒ…ï¼ˆå…¼å®¹æ€§ä¼˜åŒ–ï¼‰ $(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
        else
          echo "tag=skia-compat-v${{ github.run_number }}" >> $GITHUB_OUTPUT
          echo "name=Skiaå…¨å¹³å°æ„å»ºåŒ…ï¼ˆå…¼å®¹æ€§ä¼˜åŒ–ï¼‰ v${{ github.run_number }}" >> $GITHUB_OUTPUT
        fi
        
    # åˆ›å»ºGitHub Release
    - name: åˆ›å»ºGitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.get_tag.outputs.tag }}
        name: ${{ steps.get_tag.outputs.name }}
        body: |
          # Skia å…¨å¹³å°æ„å»ºåŒ…ï¼ˆå…¼å®¹æ€§ä¼˜åŒ–ç‰ˆæœ¬ï¼‰
          
          è¿™ä¸ªå‘å¸ƒåŒ…æ˜¯é’ˆå¯¹ç¼–è¯‘å…¼å®¹æ€§é—®é¢˜è¿›è¡Œäº†ä¸“é—¨ä¼˜åŒ–çš„Skiaå›¾å½¢åº“é¢„æ„å»ºç‰ˆæœ¬ã€‚
          
          ## ğŸ”§ ä¿®å¤çš„é—®é¢˜
          
          - âœ… **ä¿®å¤äº†macOSä¸Šçš„protobuf constinitç¼–è¯‘é”™è¯¯**
          - âœ… **ä¿®å¤äº†Androidä¸Šçš„Dawnæ„å»ºé…ç½®é”™è¯¯**
          - âœ… **ä¼˜åŒ–äº†ç¼–è¯‘å™¨å…¼å®¹æ€§è®¾ç½®**
          - âœ… **ä½¿ç”¨ç¨³å®šçš„ä¾èµ–ç‰ˆæœ¬**
          
          ## ğŸ“¦ åŒ…å«çš„å¹³å°
          
          ### æ¡Œé¢å¹³å°
          - **Windows x64** 
            - å›¾å½¢åç«¯: DirectX 11/12 + Vulkan + OpenGL
            - ç¼–è¯‘å™¨: Clang (å…¼å®¹æ€§ä¼˜åŒ–)
          
          - **macOS Intel x64 & Apple Silicon ARM64**
            - å›¾å½¢åç«¯: Metal + Vulkan + OpenGL
            - ä¿®å¤äº†Xcode 15çš„constinité—®é¢˜
            - æœ€ä½ç‰ˆæœ¬: macOS 11.0
          
          - **Linux x64**
            - å›¾å½¢åç«¯: Vulkan + OpenGL
            - ç¼–è¯‘å™¨: Clang 12
            - X11å®Œæ•´æ”¯æŒ
          
          ### ç§»åŠ¨å¹³å°
          - **Android x64 & ARM64**
            - å›¾å½¢åç«¯: Vulkan + OpenGL ES
            - Android APIçº§åˆ«: 23+
            - NDKç‰ˆæœ¬: r23c (ç¨³å®šç‰ˆæœ¬)
            - ä¿®å¤äº†enable_java_templatesé…ç½®é”™è¯¯
          
          ## ğŸš€ ä½¿ç”¨æ–¹æ³•
          
          ### CMakeé›†æˆï¼ˆæ¨èï¼‰
          ```cmake
          # ä½¿ç”¨C++17ç¡®ä¿å…¼å®¹æ€§
          set(CMAKE_CXX_STANDARD 17)
          set(CMAKE_CXX_STANDARD_REQUIRED ON)
          
          # æ·»åŠ Skiaåº“
          add_subdirectory(path/to/Skia)
          
          # é“¾æ¥åˆ°ä½ çš„é¡¹ç›®
          target_link_libraries(your_target skdn::skdn)
          ```
          
          ### åŸºç¡€ä½¿ç”¨ç¤ºä¾‹
          ```cpp
          #include "include/core/SkCanvas.h"
          #include "include/core/SkSurface.h"
          #include "include/gpu/GrDirectContext.h"
          
          // ä½¿ç”¨Skiaæ¸²æŸ“
          auto surface = SkSurface::MakeRasterN32Premul(800, 600);
          auto canvas = surface->getCanvas();
          
          // ç»˜åˆ¶å†…å®¹
          SkPaint paint;
          paint.setColor(SK_ColorBLUE);
          canvas->drawCircle(400, 300, 100, paint);
          ```
          
          ## âš¡ å…¼å®¹æ€§ç‰¹æ€§
          
          - **ğŸ”§ ç¼–è¯‘å™¨å…¼å®¹æ€§**: æ”¯æŒæ‰€æœ‰ä¸»æµç¼–è¯‘å™¨
          - **ğŸ“± å¹³å°å…¼å®¹æ€§**: è‡ªåŠ¨æ£€æµ‹å¹³å°å¹¶é“¾æ¥å¯¹åº”åº“
          - **ğŸ› ï¸ æ„å»ºå…¼å®¹æ€§**: é’ˆå¯¹å¸¸è§ç¼–è¯‘é”™è¯¯è¿›è¡Œäº†ä¿®å¤
          - **ğŸ“¦ ä¾èµ–å…¼å®¹æ€§**: ä½¿ç”¨ç¨³å®šçš„ä¾èµ–ç‰ˆæœ¬
          - **ğŸ¯ C++17æ ‡å‡†**: ç¡®ä¿å¹¿æ³›çš„ç¼–è¯‘å™¨æ”¯æŒ
          
          ## ğŸ“‹ æŠ€æœ¯è§„æ ¼
          
          - **C++æ ‡å‡†**: C++17 (å…¼å®¹æ€§ä¼˜åŒ–)
          - **æ„å»ºæ¨¡å¼**: Release (ç¨³å®šæ€§ä¼˜å…ˆ)
          - **å›¾å½¢API**: OpenGL, Vulkan, Metal (macOS), DirectX (Windows)
          - **ç¼–è¯‘å™¨**: Clang (å„å¹³å°ä¼˜åŒ–ç‰ˆæœ¬)
          - **ä¾èµ–ç®¡ç†**: æ‰€æœ‰ä¾èµ–å·²é™æ€é“¾æ¥
          
          ## ğŸ†˜ å·²çŸ¥é—®é¢˜è§£å†³
          
          ### protobuf constinité”™è¯¯
          ```
          error: variable does not have a constant initializer
          fixed_address_empty_string{};
          ```
          **è§£å†³æ–¹æ¡ˆ**: å·²åœ¨æ„å»ºè¿‡ç¨‹ä¸­è‡ªåŠ¨åº”ç”¨ä¿®å¤è¡¥ä¸
          
          ### Dawn Androidæ„å»ºé”™è¯¯
          ```
          ERROR: Undefined identifier
          if (enable_java_templates && getenv("SWARMING_TASK_ID") != "") {
          ```
          **è§£å†³æ–¹æ¡ˆ**: å·²æ·»åŠ é»˜è®¤é…ç½®å’Œæ¡ä»¶æ£€æŸ¥
          
          ## ğŸ“ æ–‡ä»¶ç»“æ„
          
          ```
          Skia_Prebuilt.zip
          â””â”€â”€ Skia/
              â”œâ”€â”€ bin/           # å„å¹³å°å¯æ‰§è¡Œæ–‡ä»¶
              â”œâ”€â”€ lib/           # å„å¹³å°åº“æ–‡ä»¶
              â”œâ”€â”€ include/       # Skiaå¤´æ–‡ä»¶
              â”œâ”€â”€ modules/       # Skiaæ¨¡å—
              â”œâ”€â”€ dawn/          # Dawn WebGPUï¼ˆåŸºç¡€æ”¯æŒï¼‰
              â”œâ”€â”€ third_party/   # ç¬¬ä¸‰æ–¹ä¾èµ–
              â”œâ”€â”€ CMakeLists.txt # å…¼å®¹æ€§ä¼˜åŒ–çš„CMakeé…ç½®
              â””â”€â”€ BUILD_INFO.txt # è¯¦ç»†æ„å»ºä¿¡æ¯
          ```
          
          ## ğŸ”— ä¸‹è½½è¯´æ˜
          
          - **Skia_Prebuilt.zip**: åŒ…å«æ‰€æœ‰å¹³å°çš„å®Œæ•´æ„å»ºåŒ…
          - **å•å¹³å°åŒ…**: å¦‚æœåªéœ€è¦ç‰¹å®šå¹³å°ï¼Œå¯ä¸‹è½½å¯¹åº”çš„å•å¹³å°ZIPåŒ…
          
          ---
          
          ğŸ‰ è¿™ä¸ªç‰ˆæœ¬ä¸“é—¨è§£å†³äº†ç¼–è¯‘å…¼å®¹æ€§é—®é¢˜ï¼Œç¡®ä¿èƒ½åœ¨å„ç§ç¯å¢ƒä¸‹æˆåŠŸæ„å»ºï¼
        files: |
          Skia_Prebuilt.zip
          artifacts/*/*.zip
        draft: false
        prerelease: false
        generate_release_notes: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
