name: ç¼–è¯‘ Skia + Dawn å…¨å¹³å°æ„å»ºåŒ…ï¼ˆå«ç¼“å­˜ä¸æµ…å…‹éš†ä¼˜åŒ–ï¼‰

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    # æ¯å¤© UTC 00:00 è§¦å‘ï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰
    - cron: '0 0 * * *'

permissions:
  contents: write
  packages: write
  actions: read

env:
  BUILD_TYPE: RelWithDebInfo

jobs:
  build:
    name: æ„å»º Skia + Dawn (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-2022
            platform: x64_windows
            target_os: win
            arch: x64
            compiler: msvc2022
          - os: ubuntu-24.04
            platform: x64_linux
            target_os: linux
            arch: x64
            compiler: clang18
          - os: ubuntu-24.04
            platform: x64_android
            target_os: android
            arch: x64
            android_api: 21
            compiler: clang18
          - os: ubuntu-24.04
            platform: arm64_android
            target_os: android
            arch: arm64
            android_api: 21
            compiler: clang18

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- é¢„ç•™æ¸…ç†ç©ºé—´æ­¥éª¤ ----------
      - name: æ¸…ç† runner ä¸´æ—¶æ–‡ä»¶ï¼ˆå¦‚æœ‰å¿…è¦ï¼‰
        if: runner.os == 'Linux'
        run: |
          sudo rm -rf /home/runner/work/_temp/*
          sudo rm -rf /home/runner/work/_toolcache/*
          sudo apt-get clean
        # Windows æ‰˜ç®¡ runner ä¸€èˆ¬ä¸å…è®¸ sudoï¼Œè‹¥ä½¿ç”¨è‡ªæ‰˜ç®¡å¯æŒ‰éœ€æ¸…ç†

      # ---------- è®¾ç½® Python ----------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # ---------- å®‰è£… Linux ä¾èµ– ----------
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ninja-build cmake clang-18 gcc-13 g++-13 \
            libfontconfig1-dev libfreetype6-dev libgl1-mesa-dev libvulkan-dev vulkan-tools \
            libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev libx11-dev libicu-dev libharfbuzz-dev \
            openjdk-11-jdk
          # ä¼˜åŒ–ï¼šæ¸…ç† apt ç¼“å­˜ï¼Œè…¾å‡ºç©ºé—´
          sudo apt-get clean

      # ---------- å®‰è£… Windows ä¾èµ– ----------
      - name: Install Windows dependencies
        if: runner.os == 'Windows'
        run: |
          choco install ninja -y
          choco install llvm --version=18.1.8 --force -y
          # å°† LLVM bin åŠ å…¥ PATH
          echo "C:\\Program Files\\LLVM\\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      # ---------- Setup MSBuildï¼ˆWindowsï¼‰ ----------
      - name: Setup MSBuild
        if: runner.os == 'Windows'
        uses: microsoft/setup-msbuild@v2

      # ---------- Setup Android NDK ----------
      - name: Setup Android NDK
        if: matrix.target_os == 'android'
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d

      # ---------- ç¼“å­˜ depot_tools ----------
      - name: Cache depot_tools
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/depot_tools
          # key å¯ä»¥æ ¹æ® repo å†…å®¹å˜åŒ–ï¼Œæˆ–æŒ‰å›ºå®šç‰ˆæœ¬ã€æ—¥æœŸç­‰ã€‚æ­¤å¤„ç¤ºä¾‹åŸºäº runner.os + å›ºå®š keyï¼Œç¡®ä¿åŒä¸€ runner.os ä¸‹å¤ç”¨
          key: ${{ runner.os }}-depot-tools-v1
          restore-keys: |
            ${{ runner.os }}-depot-tools-

      # ---------- è·å– depot_tools ----------
      - name: Get depot_tools
        run: |
          # å¦‚æœç¼“å­˜æœªå‘½ä¸­ä¼šæ‰§è¡Œ cloneï¼›å¦‚æœå·²å­˜åœ¨ç›®å½•ï¼Œåˆ™è·³è¿‡
          if [ ! -d "${{ github.workspace }}/depot_tools" ]; then
            git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git "${{ github.workspace }}/depot_tools"
          else
            echo "depot_tools å·²å­˜åœ¨ï¼Œè·³è¿‡ clone"
          fi
          # å°† depot_tools åŠ å…¥ PATH
          echo "${{ github.workspace }}/depot_tools" >> $GITHUB_PATH
        shell: bash

      # ---------- é…ç½® depot_tools åœ¨ Windows ä¸Šï¼ˆBashï¼‰ ----------
      - name: Configure depot_tools on Windows
        if: runner.os == 'Windows'
        run: |
          # å‡è®¾æ‚¨åœ¨ runner ä¸Šé¢„å…ˆå‡†å¤‡äº† depot_toolsï¼Œåœ¨ Windows ä¸Šç”¨ bash æ–¹å¼è¿½åŠ 
          echo "C:\\a\\SkiaGenerator\\SkiaGenerator\\depot_tools" >> $GITHUB_PATH
        shell: bash

      # ---------- Fetch Skia with gclient syncï¼ˆæµ…åŒæ­¥ï¼‰ ----------
      - name: Fetch Skia
        run: |
          export PATH=${{ github.workspace }}/depot_tools:$PATH
          # æ¸…ç†æ—§ç›®å½•ï¼ˆè‹¥ä¸Šæ¬¡æ®‹ç•™ï¼‰
          rm -rf skia-build
          mkdir skia-build && cd skia-build
          gclient config --name skia https://skia.googlesource.com/skia.git
          # ä½¿ç”¨ --no-history å‡å°‘æ‹‰å–å†å²ï¼›å¦‚éœ€æ›´èŠ‚çœï¼Œå¯å°è¯• --shallowï¼ˆä¾æ® gclient ç‰ˆæœ¬æ”¯æŒï¼‰
          gclient sync --no-history --jobs 4
        shell: bash

      # ---------- Fetch Dawnï¼ˆæµ…å…‹éš† + ä¾èµ–æ‹‰å–ï¼‰ ----------
      - name: Fetch Dawn
        run: |
          # æ¸…ç†æ—§ç›®å½•
          rm -rf dawn-source
          # æµ…å…‹éš† Dawnï¼ŒåŒ…å«å­æ¨¡å—æµ…åŒæ­¥ï¼ˆå¦‚æœ Git ç‰ˆæœ¬æ”¯æŒ --shallow-submodulesï¼‰
          git clone --depth 1 --recursive --shallow-submodules https://dawn.googlesource.com/dawn.git dawn-source || {
            echo "Shallow clone ä¸æ”¯æŒ? å°è¯•ä¸å¸¦ --shallow-submodules";
            rm -rf dawn-source;
            git clone --depth 1 --recursive https://dawn.googlesource.com/dawn.git dawn-source;
          }
          # è¿›å…¥æ‹‰å–ä¾èµ–
          cd dawn-source
          python3 tools/fetch_dawn_dependencies.py
        shell: bash

      # ---------- Configure Dawn ----------
      - name: Configure Dawn
        run: |
          cd dawn-source
          BUILD_DIR="build-${{ matrix.platform }}"
          rm -rf ${BUILD_DIR}
          mkdir -p ${BUILD_DIR} && cd ${BUILD_DIR}
          case "${{ matrix.target_os }}" in
            win)
              cmake .. -G "Visual Studio 17 2022" -A ${{ matrix.arch }} -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
                -DDAWN_BUILD_SAMPLES=OFF -DDAWN_BUILD_TESTS=OFF \
                -DDAWN_ENABLE_D3D11=ON -DDAWN_ENABLE_D3D12=ON -DDAWN_ENABLE_VULKAN=ON -DDAWN_ENABLE_OPENGL=ON \
                -DCMAKE_CXX_STANDARD=20 -DDAWN_USE_BUILT_DXC=ON
              ;;
            linux)
              cmake .. -G Ninja -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
                -DCMAKE_C_COMPILER=clang-18 -DCMAKE_CXX_COMPILER=clang++-18 \
                -DDAWN_BUILD_SAMPLES=OFF -DDAWN_BUILD_TESTS=OFF -DDAWN_ENABLE_VULKAN=ON -DDAWN_ENABLE_OPENGL=ON \
                -DCMAKE_CXX_STANDARD=20
              ;;
            android)
              ANDROID_ABI=$([[ ${{ matrix.arch }} == 'arm64' ]] && echo arm64-v8a || echo x86_64)
              cmake .. -G Ninja -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
                -DCMAKE_SYSTEM_NAME=Android -DCMAKE_ANDROID_NDK=$ANDROID_NDK_HOME \
                -DCMAKE_ANDROID_ARCH_ABI=$ANDROID_ABI -DCMAKE_ANDROID_API=${{ matrix.android_api }} \
                -DDAWN_BUILD_SAMPLES=OFF -DDAWN_BUILD_TESTS=OFF -DDAWN_ENABLE_VULKAN=ON -DDAWN_ENABLE_OPENGLES=ON \
                -DCMAKE_CXX_STANDARD=20
              ;;
          esac
        shell: bash

      # ---------- Build Dawn ----------
      - name: Build Dawn
        run: |
          cd dawn-source/build-${{ matrix.platform }}
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            cmake --build . --config $BUILD_TYPE --parallel 4
          else
            ninja -j4
          fi
          echo "âœ… Dawn ç¼–è¯‘å®Œæˆ"
        shell: bash

      # ---------- Configure Skia ----------
      - name: Configure Skia
        run: |
          cd skia-build/skia
          export PATH=${{ github.workspace }}/depot_tools:$PATH
          python3 tools/git-sync-deps
          # è¿™é‡Œç”¨ no-history å·²åœ¨åŒæ­¥æ—¶å‡å°‘äº†å†å²ï¼›åç»­ build args æŒ‰éœ€å®šåˆ¶
          args="is_official_build=false is_debug=false extra_cflags=[\"-O2\",\"-g\"] skia_use_dawn=true skia_dawn_dir=\"../../dawn-source\""
          args+=" skia_enable_gpu=true skia_use_gl=true skia_use_vulkan=true skia_enable_spirv_validation=false"
          args+=" skia_enable_pdf=true skia_enable_skottie=true skia_enable_skshaper=true skia_enable_svg=true skia_use_icu=true"
          args+=" skia_enable_tools=false target_os=\"${{ matrix.target_os }}\" target_cpu=\"${{ matrix.arch }}\""
          case "${{ matrix.target_os }}" in
            win)
              args+=" skia_use_angle=true skia_use_direct3d=true skia_use_freetype=true skia_use_harfbuzz=true cc=clang cxx=clang++ clang_win=\"C:/Program Files/LLVM\""
              ;;
            linux)
              args+=" skia_use_x11=true skia_use_freetype=true skia_use_fontconfig=true skia_use_harfbuzz=true cc=clang-18 cxx=clang++-18"
              ;;
            android)
              args+=" ndk=\"$ANDROID_NDK_HOME\" android_api_level=${{ matrix.android_api }} skia_use_freetype=true skia_enable_fontmgr_android=true skia_use_vulkan=true skia_use_harfbuzz=true"
              ;;
          esac
          echo "BUILD_ARGS=$args" >> $GITHUB_ENV
        shell: bash

      # ---------- Generate Skia build files ----------
      - name: Generate Skia build files
        run: |
          cd skia-build/skia
          export PATH=${{ github.workspace }}/depot_tools:$PATH
          bin/gn gen out/Release --args="$BUILD_ARGS"
        shell: bash

      # ---------- Build Skia ----------
      - name: Build Skia
        run: |
          cd skia-build/skia
          export PATH=${{ github.workspace }}/depot_tools:$PATH
          ninja -C out/Release -j4
          echo "âœ… Skia ç¼–è¯‘å®Œæˆ"
        shell: bash

      # ---------- Collect Dawn ç”Ÿæˆå¤´æ–‡ä»¶ç­‰ ----------
      - name: Collect Dawn generated
        run: |
          mkdir -p dawn-gen/include/dawn dawn-gen/include/webgpu dawn-gen/src/dawn dawn-gen/src/emdawnwebgpu dawn-gen/webgpu-headers
          cp -r dawn-source/build-${{ matrix.platform }}/gen/include/dawn/* dawn-gen/include/dawn/ || true
          cp -r dawn-source/build-${{ matrix.platform }}/gen/include/webgpu/* dawn-gen/include/webgpu/ || true
          cp -r dawn-source/build-${{ matrix.platform }}/gen/src/dawn/* dawn-gen/src/dawn/ || true
          cp -r dawn-source/build-${{ matrix.platform }}/gen/src/emdawnwebgpu/* dawn-gen/src/emdawnwebgpu/ || true
          cp -r dawn-source/build-${{ matrix.platform }}/gen/webgpu-headers/* dawn-gen/webgpu-headers/ || true
        shell: bash

      # ---------- Package artifacts ----------
      - name: Package artifacts
        run: |
          mkdir -p Skia/include/core Skia/include/dawn Skia/include/modules Skia/lib/${{ matrix.target_os }}/${{ matrix.arch }} Skia/bin/${{ matrix.target_os }}/${{ matrix.arch }}
          cp -r skia-build/skia/include/* Skia/include/core/
          cp -r skia-build/skia/modules/* Skia/include/modules/ || true
          cp -r dawn-source/include/* Skia/include/dawn/ || true
          cp -r dawn-gen/include/dawn/* Skia/include/dawn/ || true
          cp -r dawn-gen/include/webgpu/* Skia/include/dawn/ || true
          find skia-build/skia/out/Release -type f \( -name "*.a" -o -name "*.so" -o -name "*.dll" -o -name "*.lib" \) -exec cp {} Skia/{lib,bin}/${{ matrix.target_os }}/${{ matrix.arch }}/ \;
          echo "âœ… æ‰“åŒ…å®Œæˆ"
        shell: bash

      # ---------- Zip ----------
      - name: Zip
        run: |
          if [ "$RUNNER_OS" = "Windows" ]; then
            powershell "Compress-Archive -Path Skia\\* -DestinationPath ${{ matrix.platform }}.zip"
          else
            zip -r "${{ matrix.platform }}.zip" Skia/
          fi
        shell: bash

      # ---------- Upload artifact ----------
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}
          path: ${{ matrix.platform }}.zip
          retention-days: 30

  release:
    needs: build
    if: >-
      github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      || github.event_name == 'schedule'
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      packages: write

    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Determine tag
        id: tag
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "tag=skia-dawn-daily-$(date +%Y%m%d)" >> $GITHUB_OUTPUT
            echo "name=Skia+Dawn æ—¥å¸¸æ„å»º $(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          else
            echo "tag=skia-dawn-build-${{ github.run_number }}" >> $GITHUB_OUTPUT
            echo "name=Skia+Dawn æ„å»º v${{ github.run_number }}" >> $GITHUB_OUTPUT
          fi
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.name }}
          files: artifacts/**/*.zip
          draft: false
          prerelease: false
          make_latest: true

  notify:
    needs: release
    runs-on: ubuntu-24.04
    steps:
      - name: Done
        run: echo "ğŸ‰ å®Œæˆ Skia + Dawn å…¨å¹³å°æ„å»ºä¸å‘å¸ƒï¼"
