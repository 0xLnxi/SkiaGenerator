name: ç¼–è¯‘ Skia å¤šå¹³å°æž„å»ºåŒ…

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-skia:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows x64
          - os: windows-latest
            platform: x64_windows
            arch: x64
            target_os: win
            target_cpu: x64
            
          # Windows ARM64
          - os: windows-latest
            platform: arm64_windows
            arch: arm64
            target_os: win
            target_cpu: arm64
            
          # macOS x64
          - os: macos-latest
            platform: x64_macos
            arch: x64
            target_os: mac
            target_cpu: x64
            
          # macOS ARM64
          - os: macos-latest
            platform: arm64_macos
            arch: arm64
            target_os: mac
            target_cpu: arm64
            
          # Linux x64
          - os: ubuntu-latest
            platform: x64_linux
            arch: x64
            target_os: linux
            target_cpu: x64
            
          # Linux ARM64
          - os: ubuntu-latest
            platform: arm64_linux
            arch: arm64
            target_os: linux
            target_cpu: arm64
            
          # Android x64
          - os: ubuntu-latest
            platform: x64_android
            arch: x64
            target_os: android
            target_cpu: x64
            
          # Android ARM64
          - os: ubuntu-latest
            platform: arm64_android
            arch: arm64
            target_os: android
            target_cpu: arm64

    steps:
    - name: æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4
      
    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: å®‰è£…Linuxç³»ç»Ÿä¾èµ–
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libfontconfig1-dev libfreetype6-dev libgl1-mesa-dev
        # å¦‚æžœæ˜¯ARM64å¹³å°ï¼Œå®‰è£…äº¤å‰ç¼–è¯‘å·¥å…·é“¾
        if [ "${{ matrix.target_cpu }}" = "arm64" ] && [ "${{ matrix.target_os }}" = "linux" ]; then
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
        fi
        
    - name: å®‰è£…macOSç³»ç»Ÿä¾èµ–
      if: runner.os == 'macOS'
      run: |
        # macOSé€šå¸¸å·²ç»åŒ…å«æ‰€éœ€çš„å¼€å‘å·¥å…·
        xcode-select --install 2>/dev/null || true
        
    - name: å®‰è£…Windowsç³»ç»Ÿä¾èµ–
      if: runner.os == 'Windows'
      run: |
        # Windowsé€šå¸¸ä½¿ç”¨Visual Studioæž„å»ºå·¥å…·
        echo "ä½¿ç”¨Windowsé»˜è®¤æž„å»ºçŽ¯å¢ƒ"
        
    - name: è®¾ç½®Android NDK (ä»…Androidå¹³å°)
      if: matrix.target_os == 'android'
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25c
        
    - name: èŽ·å–depot_tools
      run: |
        git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
        echo "${{ github.workspace }}/depot_tools" >> $GITHUB_PATH
      shell: bash
      
    - name: è®¾ç½®depot_toolsçŽ¯å¢ƒå˜é‡ (Windows)
      if: runner.os == 'Windows'
      run: |
        echo "${{ github.workspace }}\depot_tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        
    - name: èŽ·å–Skiaæºä»£ç 
      run: |
        git clone https://skia.googlesource.com/skia.git
        cd skia
        python tools/git-sync-deps
      shell: bash
      
    - name: é…ç½®æž„å»ºå‚æ•°
      run: |
        cd skia
        
        # åŸºç¡€æž„å»ºå‚æ•°
        args="is_official_build=true"
        args="$args skia_use_system_expat=false"
        args="$args skia_use_system_icu=false"
        args="$args skia_use_system_libjpeg_turbo=false"
        args="$args skia_use_system_libpng=false"
        args="$args skia_use_system_libwebp=false"
        args="$args skia_use_system_zlib=false"
        args="$args skia_use_dng_sdk=false"
        args="$args skia_use_piex=false"
        
        # è®¾ç½®ç›®æ ‡å¹³å°å’Œæž¶æž„
        args="$args target_os=\"${{ matrix.target_os }}\""
        args="$args target_cpu=\"${{ matrix.target_cpu }}\""
        
        # æ ¹æ®å¹³å°è®¾ç½®ç‰¹å®šå‚æ•°
        case "${{ matrix.target_os }}" in
          "win")
            # Windowsç‰¹å®šé…ç½®
            args="$args clang_win=\"${{ github.workspace }}/depot_tools/win_toolchain\""
            if [ "${{ matrix.target_cpu }}" = "arm64" ]; then
              args="$args target_cpu=\"arm64\""
            fi
            ;;
          "mac")
            # macOSç‰¹å®šé…ç½®
            args="$args skia_use_metal=true"
            if [ "${{ matrix.target_cpu }}" = "arm64" ]; then
              args="$args target_cpu=\"arm64\""
            fi
            ;;
          "linux")
            # Linuxç‰¹å®šé…ç½®
            if [ "${{ matrix.target_cpu }}" = "arm64" ]; then
              args="$args cc=\"aarch64-linux-gnu-gcc\""
              args="$args cxx=\"aarch64-linux-gnu-g++\""
              args="$args ar=\"aarch64-linux-gnu-ar\""
            fi
            ;;
          "android")
            # Androidç‰¹å®šé…ç½®
            args="$args ndk=\"$ANDROID_NDK_ROOT\""
            args="$args skia_use_system_freetype2=false"
            args="$args skia_enable_fontmgr_android=true"
            ;;
        esac
        
        echo "æž„å»ºå‚æ•°: $args"
        echo "BUILD_ARGS=$args" >> $GITHUB_ENV
      shell: bash
      
    - name: ç”Ÿæˆæž„å»ºæ–‡ä»¶
      run: |
        cd skia
        bin/gn gen out/Release --args="$BUILD_ARGS"
      shell: bash
      
    - name: ç¼–è¯‘Skia
      run: |
        cd skia
        ninja -C out/Release
      shell: bash
      
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        cd skia
        
        # åˆ›å»ºè¾“å‡ºç›®å½•ç»“æž„
        mkdir -p package/include
        mkdir -p package/lib
        mkdir -p package/bin
        mkdir -p package/docs
        
        # å¤åˆ¶å¤´æ–‡ä»¶
        cp -r include/* package/include/
        
        # å¤åˆ¶åº“æ–‡ä»¶å’Œå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ ¹æ®å¹³å°ç±»åž‹å¤„ç†
        case "${{ matrix.target_os }}" in
          "win")
            # Windowså¹³å°æ–‡ä»¶
            find out/Release -name "*.lib" -exec cp {} package/lib/ \; 2>/dev/null || true
            find out/Release -name "*.dll" -exec cp {} package/bin/ \; 2>/dev/null || true
            find out/Release -name "*.exe" -exec cp {} package/bin/ \; 2>/dev/null || true
            ;;
          "mac")
            # macOSå¹³å°æ–‡ä»¶
            find out/Release -name "*.a" -exec cp {} package/lib/ \; 2>/dev/null || true
            find out/Release -name "*.dylib" -exec cp {} package/lib/ \; 2>/dev/null || true
            find out/Release -type f -perm +111 -name "dm" -exec cp {} package/bin/ \; 2>/dev/null || true
            find out/Release -type f -perm +111 -name "nanobench" -exec cp {} package/bin/ \; 2>/dev/null || true
            ;;
          "linux"|"android")
            # Linux/Androidå¹³å°æ–‡ä»¶
            find out/Release -name "*.a" -exec cp {} package/lib/ \; 2>/dev/null || true
            find out/Release -name "*.so" -exec cp {} package/lib/ \; 2>/dev/null || true
            find out/Release -type f -perm +111 -name "dm" -exec cp {} package/bin/ \; 2>/dev/null || true
            find out/Release -type f -perm +111 -name "nanobench" -exec cp {} package/bin/ \; 2>/dev/null || true
            ;;
        esac
        
        # åˆ›å»ºæž„å»ºä¿¡æ¯æ–‡ä»¶
        cat > package/BUILD_INFO.txt << EOF
Skia æž„å»ºä¿¡æ¯
==================
å¹³å°: ${{ matrix.target_os }}
æž¶æž„: ${{ matrix.target_cpu }}
åŒ…å: ${{ matrix.platform }}
æž„å»ºæ¨¡å¼: Release (å®˜æ–¹æž„å»º)
Gitåˆ†æ”¯: $(git branch --show-current)
Gitæäº¤: $(git rev-parse HEAD)
EOF
        
        # åˆ›å»ºREADMEæ–‡ä»¶
        cat > package/README.md << EOF
# Skia æž„å»ºåŒ… - ${{ matrix.platform }}

è¿™æ˜¯Skiaå›¾å½¢åº“çš„é¢„ç¼–è¯‘æž„å»ºåŒ…ã€‚

## åŒ…å«å†…å®¹

- \`include/\` - Skiaå¤´æ–‡ä»¶
- \`lib/\` - é™æ€åº“æ–‡ä»¶å’ŒåŠ¨æ€åº“æ–‡ä»¶
- \`bin/\` - å¯æ‰§è¡Œå·¥å…·ç¨‹åº
- \`BUILD_INFO.txt\` - è¯¦ç»†æž„å»ºä¿¡æ¯

## ä½¿ç”¨è¯´æ˜Ž

è¯·æ ¹æ®ä½ çš„é¡¹ç›®éœ€æ±‚ï¼Œå°†ç›¸åº”çš„å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶é›†æˆåˆ°ä½ çš„æž„å»ºç³»ç»Ÿä¸­ã€‚

## å¹³å°ä¿¡æ¯

- ç›®æ ‡æ“ä½œç³»ç»Ÿ: ${{ matrix.target_os }}
- ç›®æ ‡æž¶æž„: ${{ matrix.target_cpu }}
EOF
        
      shell: bash
      
    - name: æ‰“åŒ…æž„å»ºäº§ç‰©
      run: |
        cd skia/package
        
        # æ ¹æ®å¹³å°é€‰æ‹©åˆé€‚çš„æ‰“åŒ…æ–¹å¼
        if [ "${{ runner.os }}" = "Windows" ]; then
          # Windowsä½¿ç”¨7zip
          7z a "../${{ matrix.platform }}.zip" *
        else
          # Unixç³»ç»Ÿä½¿ç”¨zip
          zip -r "../${{ matrix.platform }}.zip" *
        fi
        
        # éªŒè¯zipæ–‡ä»¶æ˜¯å¦åˆ›å»ºæˆåŠŸ
        if [ -f "../${{ matrix.platform }}.zip" ]; then
          echo "âœ… æˆåŠŸåˆ›å»º ${{ matrix.platform }}.zip"
          ls -lh "../${{ matrix.platform }}.zip"
        else
          echo "âŒ åˆ›å»ºzipæ–‡ä»¶å¤±è´¥"
          exit 1
        fi
      shell: bash
      
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform }}
        path: skia/${{ matrix.platform }}.zip
        retention-days: 30
        compression-level: 0  # zipæ–‡ä»¶å·²ç»åŽ‹ç¼©ï¼Œä¸éœ€è¦å†æ¬¡åŽ‹ç¼©
        
  # åˆ›å»ºå‘å¸ƒæ±‡æ€»
  create-release:
    needs: build-skia
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: éªŒè¯æ‰€æœ‰æž„å»ºäº§ç‰©
      run: |
        echo "ðŸ“¦ éªŒè¯æž„å»ºäº§ç‰©..."
        total_size=0
        
        for dir in artifacts/*/; do
          if [ -d "$dir" ]; then
            platform=$(basename "$dir")
            zip_file="$dir$platform.zip"
            if [ -f "$zip_file" ]; then
              size=$(stat -f%z "$zip_file" 2>/dev/null || stat -c%s "$zip_file")
              echo "âœ… $platform.zip - $(numfmt --to=iec $size)"
              total_size=$((total_size + size))
            else
              echo "âŒ ç¼ºå°‘ $platform.zip"
            fi
          fi
        done
        
        echo "ðŸ“Š æ€»å¤§å°: $(numfmt --to=iec $total_size)"
        
    - name: åˆ›å»ºå‘å¸ƒè¯´æ˜Ž
      run: |
        cat > RELEASE_NOTES.md << 'EOF'
# ðŸŽ¨ Skia å¤šå¹³å°æž„å»ºåŒ…

è¿™ä¸ªå‘å¸ƒåŒ…åŒ…å«äº†Skiaå›¾å½¢åº“åœ¨å¤šä¸ªå¹³å°å’Œæž¶æž„ä¸Šçš„é¢„ç¼–è¯‘ç‰ˆæœ¬ã€‚

## ðŸ“‹ åŒ…å«çš„å¹³å°

### Windows
- âœ… `x64_windows.zip` - Windows x64æž¶æž„
- âœ… `arm64_windows.zip` - Windows ARM64æž¶æž„

### macOS  
- âœ… `x64_macos.zip` - macOS Intelæž¶æž„
- âœ… `arm64_macos.zip` - macOS Apple Siliconæž¶æž„

### Linux
- âœ… `x64_linux.zip` - Linux x64æž¶æž„  
- âœ… `arm64_linux.zip` - Linux ARM64æž¶æž„

### Android
- âœ… `x64_android.zip` - Android x64æž¶æž„
- âœ… `arm64_android.zip` - Android ARM64æž¶æž„

## ðŸ“¦ æ¯ä¸ªåŒ…éƒ½åŒ…å«

- `include/` - å®Œæ•´çš„Skia C++ APIå¤´æ–‡ä»¶
- `lib/` - é™æ€åº“å’ŒåŠ¨æ€åº“æ–‡ä»¶
- `bin/` - å®žç”¨å·¥å…·ç¨‹åº(dm, nanobenchç­‰)
- `BUILD_INFO.txt` - è¯¦ç»†çš„æž„å»ºä¿¡æ¯
- `README.md` - ä½¿ç”¨è¯´æ˜Ž

## ðŸ”§ æž„å»ºé…ç½®

- æž„å»ºæ¨¡å¼: Release (å®˜æ–¹ä¼˜åŒ–æž„å»º)
- æ‰€æœ‰ä¾èµ–: é™æ€é“¾æŽ¥ï¼Œæ— å¤–éƒ¨ä¾èµ–
- å›¾å½¢åŽç«¯: é’ˆå¯¹æ¯ä¸ªå¹³å°ä¼˜åŒ–

## ðŸ“– ä½¿ç”¨æ–¹æ³•

1. ä¸‹è½½å¯¹åº”å¹³å°çš„zipæ–‡ä»¶
2. è§£åŽ‹åˆ°ä½ çš„é¡¹ç›®ç›®å½•
3. åœ¨æž„å»ºç³»ç»Ÿä¸­å¼•ç”¨includeå’Œlibç›®å½•
4. å¼€å§‹ä½¿ç”¨Skia APIè¿›è¡Œå›¾å½¢å¼€å‘

EOF
        
    - name: åˆ›å»ºGitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: skia-build-${{ github.run_number }}
        name: ðŸŽ¨ Skiaæž„å»ºåŒ… v${{ github.run_number }}
        body_path: RELEASE_NOTES.md
        files: |
          artifacts/x64_windows/*.zip
          artifacts/arm64_windows/*.zip
          artifacts/x64_macos/*.zip
          artifacts/arm64_macos/*.zip
          artifacts/x64_linux/*.zip
          artifacts/arm64_linux/*.zip
          artifacts/x64_android/*.zip
          artifacts/arm64_android/*.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: æž„å»ºå®Œæˆé€šçŸ¥
      run: |
        echo "ðŸŽ‰ Skiaå¤šå¹³å°æž„å»ºå®Œæˆï¼"
        echo "ðŸ“¦ å·²ç”Ÿæˆä»¥ä¸‹å¹³å°çš„æž„å»ºåŒ…ï¼š"
        echo "   â€¢ Windows: x64, ARM64"  
        echo "   â€¢ macOS: x64, ARM64"
        echo "   â€¢ Linux: x64, ARM64"
        echo "   â€¢ Android: x64, ARM64"
        echo "ðŸ”— å¯åœ¨Actionsé¡µé¢ä¸‹è½½ï¼Œæˆ–åœ¨Releasesä¸­èŽ·å–"
