name: æ„å»ºSkiaå’ŒDawnåº“

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  BUILD_TYPE: RelWithDebInfo

jobs:
  build-windows:
    runs-on: windows-2022
    strategy:
      matrix:
        arch: [x64]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: æ¸…ç†ç£ç›˜ç©ºé—´
      run: |
        # åˆ é™¤ä¸å¿…è¦çš„é¢„å®‰è£…è½¯ä»¶
        Get-ChildItem -Path "C:\hostedtoolcache" -Recurse | Remove-Item -Force -Recurse -ErrorAction SilentlyContinue
        Get-ChildItem -Path "C:\ProgramData\chocolatey" -Recurse | Remove-Item -Force -Recurse -ErrorAction SilentlyContinue
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        Remove-Item -Path "$env:TEMP\*" -Recurse -Force -ErrorAction SilentlyContinue
      shell: powershell

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: è®¾ç½®Visual Studioç¯å¢ƒ
      uses: microsoft/setup-msbuild@v2

    - name: å®‰è£…LLVM 18
      run: |
        # ä¸‹è½½å¹¶å®‰è£…LLVM 18çš„ç²¾ç®€ç‰ˆæœ¬
        $url = "https://github.com/llvm/llvm-project/releases/download/llvmorg-18.1.8/LLVM-18.1.8-win64.exe"
        $output = "$env:TEMP\llvm-installer.exe"
        Invoke-WebRequest -Uri $url -OutFile $output
        Start-Process -FilePath $output -ArgumentList "/S" -Wait
        echo "C:\Program Files\LLVM\bin" >> $env:GITHUB_PATH
      shell: powershell

    - name: å®‰è£…Depot Tools
      run: |
        git clone --depth 1 https://chromium.googlesource.com/chromium/tools/depot_tools.git depot_tools
        echo "$env:GITHUB_WORKSPACE\depot_tools" >> $env:GITHUB_PATH
      shell: powershell

    - name: é…ç½®Gitç”¨æˆ·
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config --global core.autocrlf false
        git config --global core.filemode false
        git config --global advice.detachedHead false
      shell: cmd

    - name: ä¸‹è½½Skiaæºç ï¼ˆç²¾ç®€ç‰ˆï¼‰
      run: |
        $env:PATH = "$env:GITHUB_WORKSPACE\depot_tools;$env:PATH"
        $env:DEPOT_TOOLS_WIN_TOOLCHAIN = "0"
        mkdir skia-build
        cd skia-build
        # ä½¿ç”¨ç²¾ç®€é…ç½®ä¸‹è½½Skiaï¼Œæ’é™¤emscriptenç›¸å…³ä¾èµ–
        gclient config --name skia --unmanaged https://skia.googlesource.com/skia.git
        # ç¦ç”¨ä¸å¿…è¦çš„ä¾èµ–
        echo "solutions = [" > .gclient
        echo "  {" >> .gclient
        echo "    'name': 'skia'," >> .gclient
        echo "    'url': 'https://skia.googlesource.com/skia.git'," >> .gclient
        echo "    'managed': False," >> .gclient
        echo "    'custom_deps': {" >> .gclient
        echo "      'skia/third_party/externals/emsdk': None," >> .gclient
        echo "    }," >> .gclient
        echo "  }," >> .gclient
        echo "]" >> .gclient
        gclient sync --no-history --shallow
      shell: powershell

    - name: ä¸‹è½½Dawnæºç ï¼ˆç²¾ç®€ç‰ˆï¼‰
      run: |
        # å…‹éš†Dawnä¸»ä»“åº“ï¼Œä¸åŒ…å«å­æ¨¡å—
        git clone --depth 1 --no-recurse-submodules https://dawn.googlesource.com/dawn.git dawn-source
        cd dawn-source
        
        # åªåˆå§‹åŒ–å¿…è¦çš„å­æ¨¡å—
        git submodule update --init --depth 1 third_party/webgpu-headers
        git submodule update --init --depth 1 third_party/khronos
        git submodule update --init --depth 1 third_party/vulkan-headers
        git submodule update --init --depth 1 third_party/vulkan_memory_allocator
        
        # è·³è¿‡æœ‰é—®é¢˜çš„ANGLEå­æ¨¡å—
        git config submodule.third_party/angle.update none
        
        # æ‰‹åŠ¨ä¸‹è½½å¿…è¦çš„ä¾èµ–
        python tools/fetch_dawn_dependencies.py --skip-submodules
      shell: cmd

    - name: é…ç½®Skiaæ„å»ºå‚æ•°ï¼ˆå¯ç”¨Graphiteï¼‰
      run: |
        $env:PATH = "$env:GITHUB_WORKSPACE\depot_tools;$env:PATH"
        cd skia-build\skia
        python tools\git-sync-deps
        
        # åˆ›å»ºä¼˜åŒ–çš„æ„å»ºé…ç½®ï¼Œå¯ç”¨Graphiteä»¥æ”¯æŒDawn
        $buildArgs = @(
          "is_official_build=true",
          "is_debug=false",
          "extra_cflags=[\`"/O2\`", \`"/Zi\`"]",
          "target_cpu=\`"x64\`"",
          "skia_enable_graphite=true",
          "skia_use_dawn=true",
          "skia_use_gl=true", 
          "skia_use_direct3d=true",
          "skia_use_vulkan=true",
          "skia_enable_tools=false",
          "skia_enable_skottie=false",
          "skia_enable_svg=false",
          "skia_enable_pdf=false",
          "skia_enable_flutter_defines=false",
          "skia_use_wasm=false",
          "cc=\`"clang\`"",
          "cxx=\`"clang++\`"",
          "win_vc=\`"2022\`""
        )
        
        gn gen out\x64-windows --args="$($buildArgs -join ' ')"
      shell: powershell

    - name: é…ç½®Dawnæ„å»ºå‚æ•°
      run: |
        cd dawn-source
        mkdir build-win-x64
        cd build-win-x64
        
        cmake .. -G "Visual Studio 17 2022" -A x64 ^
          -DCMAKE_BUILD_TYPE=%BUILD_TYPE% ^
          -DDAWN_BUILD_SAMPLES=OFF ^
          -DDAWN_BUILD_BENCHMARKS=OFF ^
          -DTINT_BUILD_TESTS=OFF ^
          -DTINT_BUILD_BENCHMARKS=OFF ^
          -DDAWN_BUILD_NODE_BINDINGS=OFF ^
          -DDAWN_ENABLE_D3D11=ON ^
          -DDAWN_ENABLE_D3D12=ON ^
          -DDAWN_ENABLE_VULKAN=ON ^
          -DDAWN_ENABLE_OPENGL=ON ^
          -DDAWN_ENABLE_OPENGLES=OFF ^
          -DDAWN_ENABLE_NULL=OFF ^
          -DCMAKE_CXX_STANDARD=20 ^
          -DDAWN_FETCH_DEPENDENCIES=OFF
      shell: cmd

    - name: ç¼–è¯‘Dawnåº“
      run: |
        cd dawn-source\build-win-x64
        cmake --build . --config %BUILD_TYPE% --parallel 2 --target dawn_native dawn_platform dawn_proc webgpu_dawn
      shell: cmd

    - name: ç¼–è¯‘Skiaåº“
      run: |
        $env:PATH = "$env:GITHUB_WORKSPACE\depot_tools;$env:PATH"
        cd skia-build\skia
        ninja -C out\x64-windows -j 2 libskia.lib
      shell: powershell

    - name: æ”¶é›†Dawnç”Ÿæˆçš„æ–‡ä»¶
      run: |
        mkdir dawn-generated\include\dawn
        mkdir dawn-generated\include\webgpu
        mkdir dawn-generated\src\dawn
        
        # å¤åˆ¶ç”Ÿæˆçš„å¤´æ–‡ä»¶å’Œæºæ–‡ä»¶
        if exist dawn-source\build-win-x64\gen\include\dawn xcopy /E /I /Y dawn-source\build-win-x64\gen\include\dawn dawn-generated\include\dawn\
        if exist dawn-source\build-win-x64\gen\include\webgpu xcopy /E /I /Y dawn-source\build-win-x64\gen\include\webgpu dawn-generated\include\webgpu\
        if exist dawn-source\build-win-x64\gen\src\dawn xcopy /E /I /Y dawn-source\build-win-x64\gen\src\dawn dawn-generated\src\dawn\
      shell: cmd

    - name: å‡†å¤‡Windowsè¾“å‡ºç›®å½•
      run: |
        mkdir Skia\include\core
        mkdir Skia\include\dawn  
        mkdir Skia\include\modules
        mkdir Skia\bin\Win\x64
        mkdir Skia\lib\Win\x64
        
        # å¤åˆ¶Skiaå¤´æ–‡ä»¶
        xcopy /E /I /Y skia-build\skia\include Skia\include\core\
        if exist skia-build\skia\modules xcopy /E /I /Y skia-build\skia\modules Skia\include\modules\
        
        # å¤åˆ¶Dawnå¤´æ–‡ä»¶
        xcopy /E /I /Y dawn-source\include Skia\include\dawn\
        if exist dawn-generated\include\dawn xcopy /E /I /Y dawn-generated\include\dawn Skia\include\dawn\
        if exist dawn-generated\include\webgpu xcopy /E /I /Y dawn-generated\include\webgpu Skia\include\dawn\
        
        # å¤åˆ¶åº“æ–‡ä»¶
        copy skia-build\skia\out\x64-windows\*.lib Skia\lib\Win\x64\ 2>nul || echo "éƒ¨åˆ†Skiaåº“æ–‡ä»¶æœªæ‰¾åˆ°"
        copy dawn-source\build-win-x64\%BUILD_TYPE%\*.lib Skia\lib\Win\x64\ 2>nul || echo "éƒ¨åˆ†Dawnåº“æ–‡ä»¶æœªæ‰¾åˆ°"
        
        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶å’ŒDLL
        copy skia-build\skia\out\x64-windows\*.exe Skia\bin\Win\x64\ 2>nul || echo "æ— å¯æ‰§è¡Œæ–‡ä»¶"
        copy dawn-source\build-win-x64\%BUILD_TYPE%\*.dll Skia\bin\Win\x64\ 2>nul || echo "æ— DLLæ–‡ä»¶"
      shell: cmd

    - name: ä¸Šä¼ Windowsæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: skia-dawn-windows-x64
        path: Skia/

  build-linux:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        arch: [x64]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: æ¸…ç†ç£ç›˜ç©ºé—´
      run: |
        # åˆ é™¤ä¸å¿…è¦çš„åŒ…å’Œç¼“å­˜
        sudo apt-get clean
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        # æ˜¾ç¤ºå¯ç”¨ç©ºé—´
        df -h

    - name: å®‰è£…åŸºç¡€ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          build-essential git python3 python3-pip curl \
          libgl1-mesa-dev libglu1-mesa-dev \
          libvulkan-dev vulkan-tools \
          libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev \
          ninja-build cmake

    - name: å®‰è£…Clang 18
      run: |
        # å®‰è£…LLVMå®˜æ–¹ä»“åº“
        wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
        echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-18 main" | sudo tee /etc/apt/sources.list.d/llvm.list
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends clang-18 lld-18
        sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-18 100
        sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-18 100

    - name: å®‰è£…Depot Tools
      run: |
        git clone --depth 1 https://chromium.googlesource.com/chromium/tools/depot_tools.git
        echo "$GITHUB_WORKSPACE/depot_tools" >> $GITHUB_PATH

    - name: é…ç½®Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config --global advice.detachedHead false

    - name: ä¸‹è½½Skiaæºç ï¼ˆç²¾ç®€ç‰ˆï¼‰
      run: |
        export PATH=$GITHUB_WORKSPACE/depot_tools:$PATH
        mkdir skia-build
        cd skia-build
        
        # åˆ›å»ºç²¾ç®€çš„gclienté…ç½®ï¼Œç¦ç”¨emscripten
        cat > .gclient << 'EOF'
        solutions = [
          {
            "name": "skia",
            "url": "https://skia.googlesource.com/skia.git",
            "managed": False,
            "custom_deps": {
              "skia/third_party/externals/emsdk": None,
            },
          },
        ]
        EOF
        
        gclient sync --no-history --shallow

    - name: ä¸‹è½½Dawnæºç ï¼ˆç²¾ç®€ç‰ˆï¼‰
      run: |
        # å…‹éš†Dawnä¸»ä»“åº“
        git clone --depth 1 --no-recurse-submodules https://dawn.googlesource.com/dawn.git dawn-source
        cd dawn-source
        
        # åªåˆå§‹åŒ–å¿…è¦çš„å­æ¨¡å—
        git submodule update --init --depth 1 third_party/webgpu-headers || true
        git submodule update --init --depth 1 third_party/khronos || true
        git submodule update --init --depth 1 third_party/vulkan-headers || true
        git submodule update --init --depth 1 third_party/vulkan_memory_allocator || true
        
        # è·³è¿‡æœ‰é—®é¢˜çš„å­æ¨¡å—
        git config submodule.third_party/angle.update none

    - name: é…ç½®Skiaæ„å»ºå‚æ•°ï¼ˆå¯ç”¨Graphiteï¼‰
      run: |
        export PATH=$GITHUB_WORKSPACE/depot_tools:$PATH
        cd skia-build/skia
        python3 tools/git-sync-deps
        
        gn gen out/x64-linux --args='
          is_official_build=true
          is_debug=false
          extra_cflags=["-O2", "-g"]
          target_cpu="x64"
          skia_enable_graphite=true
          skia_use_dawn=true
          skia_use_gl=true
          skia_use_vulkan=true
          skia_enable_tools=false
          skia_enable_skottie=false
          skia_enable_svg=false
          skia_enable_pdf=false
          skia_enable_flutter_defines=false
          skia_use_wasm=false
          cc="clang-18"
          cxx="clang++-18"
        '

    - name: é…ç½®Dawnæ„å»ºå‚æ•°
      run: |
        cd dawn-source
        mkdir build-linux-x64
        cd build-linux-x64
        
        cmake .. -G Ninja \
          -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
          -DDAWN_BUILD_SAMPLES=OFF \
          -DDAWN_BUILD_BENCHMARKS=OFF \
          -DTINT_BUILD_TESTS=OFF \
          -DTINT_BUILD_BENCHMARKS=OFF \
          -DDAWN_BUILD_NODE_BINDINGS=OFF \
          -DDAWN_ENABLE_VULKAN=ON \
          -DDAWN_ENABLE_OPENGL=ON \
          -DDAWN_ENABLE_OPENGLES=OFF \
          -DDAWN_ENABLE_NULL=OFF \
          -DCMAKE_CXX_STANDARD=20 \
          -DCMAKE_C_COMPILER=clang-18 \
          -DCMAKE_CXX_COMPILER=clang++-18 \
          -DDAWN_FETCH_DEPENDENCIES=OFF

    - name: ç¼–è¯‘Dawnåº“
      run: |
        cd dawn-source/build-linux-x64
        ninja dawn_native dawn_platform dawn_proc webgpu_dawn

    - name: ç¼–è¯‘Skiaåº“
      run: |
        export PATH=$GITHUB_WORKSPACE/depot_tools:$PATH
        cd skia-build/skia
        ninja -C out/x64-linux -j 2 libskia.a

    - name: æ”¶é›†Dawnç”Ÿæˆçš„æ–‡ä»¶
      run: |
        mkdir -p dawn-generated/include/dawn
        mkdir -p dawn-generated/include/webgpu
        mkdir -p dawn-generated/src/dawn
        
        # å¤åˆ¶ç”Ÿæˆçš„æ–‡ä»¶
        if [ -d "dawn-source/build-linux-x64/gen/include/dawn" ]; then
          cp -r dawn-source/build-linux-x64/gen/include/dawn/* dawn-generated/include/dawn/
        fi
        if [ -d "dawn-source/build-linux-x64/gen/include/webgpu" ]; then
          cp -r dawn-source/build-linux-x64/gen/include/webgpu/* dawn-generated/include/webgpu/
        fi
        if [ -d "dawn-source/build-linux-x64/gen/src/dawn" ]; then
          cp -r dawn-source/build-linux-x64/gen/src/dawn/* dawn-generated/src/dawn/
        fi

    - name: å‡†å¤‡Linuxè¾“å‡ºç›®å½•
      run: |
        mkdir -p Skia/include/{core,dawn,modules}
        mkdir -p Skia/bin/Linux/x64
        mkdir -p Skia/lib/Linux/x64
        
        # å¤åˆ¶Skiaå¤´æ–‡ä»¶
        cp -r skia-build/skia/include/* Skia/include/core/
        if [ -d "skia-build/skia/modules" ]; then
          cp -r skia-build/skia/modules/* Skia/include/modules/
        fi
        
        # å¤åˆ¶Dawnå¤´æ–‡ä»¶
        cp -r dawn-source/include/* Skia/include/dawn/
        if [ -d "dawn-generated/include/dawn" ]; then
          cp -r dawn-generated/include/dawn/* Skia/include/dawn/
        fi
        if [ -d "dawn-generated/include/webgpu" ]; then
          cp -r dawn-generated/include/webgpu/* Skia/include/dawn/
        fi
        
        # å¤åˆ¶åº“æ–‡ä»¶
        find skia-build/skia/out/x64-linux -name "*.a" -exec cp {} Skia/lib/Linux/x64/ \; 2>/dev/null || true
        find dawn-source/build-linux-x64 -name "*.a" -exec cp {} Skia/lib/Linux/x64/ \; 2>/dev/null || true
        
        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        find skia-build/skia/out/x64-linux -type f -executable -exec cp {} Skia/bin/Linux/x64/ \; 2>/dev/null || true
        find dawn-source/build-linux-x64 -name "*.so" -exec cp {} Skia/bin/Linux/x64/ \; 2>/dev/null || true

    - name: ä¸Šä¼ Linuxæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: skia-dawn-linux-x64
        path: Skia/

  build-android:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        arch: [arm64, x64]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: æ¸…ç†ç£ç›˜ç©ºé—´
      run: |
        sudo apt-get clean
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        df -h

    - name: å®‰è£…åŸºç¡€ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          build-essential git python3 python3-pip curl unzip \
          ninja-build cmake

    - name: è®¾ç½®Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r26d

    - name: å®‰è£…Depot Tools
      run: |
        git clone --depth 1 https://chromium.googlesource.com/chromium/tools/depot_tools.git
        echo "$GITHUB_WORKSPACE/depot_tools" >> $GITHUB_PATH

    - name: é…ç½®Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: ä¸‹è½½Skiaæºç ï¼ˆç²¾ç®€ç‰ˆï¼‰
      run: |
        export PATH=$GITHUB_WORKSPACE/depot_tools:$PATH
        mkdir skia-build
        cd skia-build
        
        cat > .gclient << 'EOF'
        solutions = [
          {
            "name": "skia", 
            "url": "https://skia.googlesource.com/skia.git",
            "managed": False,
            "custom_deps": {
              "skia/third_party/externals/emsdk": None,
            },
          },
        ]
        EOF
        
        gclient sync --no-history --shallow

    - name: ä¸‹è½½Dawnæºç ï¼ˆç²¾ç®€ç‰ˆï¼‰
      run: |
        git clone --depth 1 --no-recurse-submodules https://dawn.googlesource.com/dawn.git dawn-source
        cd dawn-source
        
        # åªåˆå§‹åŒ–Androidéœ€è¦çš„å­æ¨¡å—
        git submodule update --init --depth 1 third_party/webgpu-headers || true
        git submodule update --init --depth 1 third_party/khronos || true
        git submodule update --init --depth 1 third_party/vulkan-headers || true
        git submodule update --init --depth 1 third_party/vulkan_memory_allocator || true

    - name: é…ç½®Skiaæ„å»ºå‚æ•°ï¼ˆå¯ç”¨Graphiteï¼‰
      run: |
        export PATH=$GITHUB_WORKSPACE/depot_tools:$PATH
        cd skia-build/skia
        python3 tools/git-sync-deps
        
        # è®¾ç½®Androidæ¶æ„å‚æ•°
        if [ "${{ matrix.arch }}" = "arm64" ]; then
          ANDROID_ARCH="arm64"
        else
          ANDROID_ARCH="x64"
        fi
        
        gn gen out/${{ matrix.arch }}-android --args="
          is_official_build=true
          is_debug=false
          target_os=\"android\"
          target_cpu=\"${ANDROID_ARCH}\"
          skia_enable_graphite=true
          skia_use_dawn=true
          skia_use_vulkan=true
          skia_use_gl=true
          skia_enable_tools=false
          skia_enable_skottie=false
          skia_enable_svg=false
          skia_enable_pdf=false
          skia_use_wasm=false
          ndk=\"${ANDROID_NDK_HOME}\"
          android_ndk_api_level=24
        "

    - name: é…ç½®Dawnæ„å»ºå‚æ•°
      run: |
        cd dawn-source
        mkdir build-android-${{ matrix.arch }}
        cd build-android-${{ matrix.arch }}
        
        # è®¾ç½®Android ABI
        if [ "${{ matrix.arch }}" = "arm64" ]; then
          ANDROID_ABI="arm64-v8a"
        else
          ANDROID_ABI="x86_64"
        fi
        
        cmake .. -G Ninja \
          -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
          -DCMAKE_SYSTEM_NAME=Android \
          -DCMAKE_ANDROID_ARCH_ABI=${ANDROID_ABI} \
          -DCMAKE_ANDROID_NDK=${ANDROID_NDK_HOME} \
          -DCMAKE_ANDROID_STL_TYPE=c++_static \
          -DCMAKE_ANDROID_API=24 \
          -DDAWN_BUILD_SAMPLES=OFF \
          -DDAWN_BUILD_BENCHMARKS=OFF \
          -DTINT_BUILD_TESTS=OFF \
          -DTINT_BUILD_BENCHMARKS=OFF \
          -DDAWN_BUILD_NODE_BINDINGS=OFF \
          -DDAWN_ENABLE_VULKAN=ON \
          -DDAWN_ENABLE_OPENGLES=ON \
          -DDAWN_ENABLE_OPENGL=OFF \
          -DDAWN_ENABLE_NULL=OFF \
          -DCMAKE_CXX_STANDARD=20 \
          -DDAWN_FETCH_DEPENDENCIES=OFF

    - name: ç¼–è¯‘Dawnåº“
      run: |
        cd dawn-source/build-android-${{ matrix.arch }}
        ninja dawn_native dawn_platform dawn_proc webgpu_dawn

    - name: ç¼–è¯‘Skiaåº“  
      run: |
        export PATH=$GITHUB_WORKSPACE/depot_tools:$PATH
        cd skia-build/skia
        ninja -C out/${{ matrix.arch }}-android -j 2 libskia.a

    - name: æ”¶é›†Dawnç”Ÿæˆçš„æ–‡ä»¶
      run: |
        mkdir -p dawn-generated/include/dawn
        mkdir -p dawn-generated/include/webgpu
        mkdir -p dawn-generated/src/dawn
        
        if [ -d "dawn-source/build-android-${{ matrix.arch }}/gen/include/dawn" ]; then
          cp -r dawn-source/build-android-${{ matrix.arch }}/gen/include/dawn/* dawn-generated/include/dawn/
        fi
        if [ -d "dawn-source/build-android-${{ matrix.arch }}/gen/include/webgpu" ]; then
          cp -r dawn-source/build-android-${{ matrix.arch }}/gen/include/webgpu/* dawn-generated/include/webgpu/
        fi
        if [ -d "dawn-source/build-android-${{ matrix.arch }}/gen/src/dawn" ]; then
          cp -r dawn-source/build-android-${{ matrix.arch }}/gen/src/dawn/* dawn-generated/src/dawn/
        fi

    - name: å‡†å¤‡Androidè¾“å‡ºç›®å½•
      run: |
        mkdir -p Skia/include/{core,dawn,modules}
        mkdir -p Skia/bin/Android/${{ matrix.arch }}
        mkdir -p Skia/lib/Android/${{ matrix.arch }}
        
        # å¤åˆ¶Skiaå¤´æ–‡ä»¶
        cp -r skia-build/skia/include/* Skia/include/core/
        if [ -d "skia-build/skia/modules" ]; then
          cp -r skia-build/skia/modules/* Skia/include/modules/
        fi
        
        # å¤åˆ¶Dawnå¤´æ–‡ä»¶
        cp -r dawn-source/include/* Skia/include/dawn/
        if [ -d "dawn-generated/include/dawn" ]; then
          cp -r dawn-generated/include/dawn/* Skia/include/dawn/
        fi
        if [ -d "dawn-generated/include/webgpu" ]; then
          cp -r dawn-generated/include/webgpu/* Skia/include/dawn/
        fi
        
        # å¤åˆ¶åº“æ–‡ä»¶
        find skia-build/skia/out/${{ matrix.arch }}-android -name "*.a" -exec cp {} Skia/lib/Android/${{ matrix.arch }}/ \; 2>/dev/null || true
        find dawn-source/build-android-${{ matrix.arch }} -name "*.a" -exec cp {} Skia/lib/Android/${{ matrix.arch }}/ \; 2>/dev/null || true
        find dawn-source/build-android-${{ matrix.arch }} -name "*.so" -exec cp {} Skia/lib/Android/${{ matrix.arch }}/ \; 2>/dev/null || true

    - name: ä¸Šä¼ Androidæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: skia-dawn-android-${{ matrix.arch }}
        path: Skia/

  package-final:
    runs-on: ubuntu-24.04
    needs: [build-windows, build-linux, build-android]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: åˆå¹¶æ‰€æœ‰æ„å»ºäº§ç‰©
      run: |
        mkdir -p Skia-Final
        
        # åˆå¹¶æ‰€æœ‰å¹³å°çš„æ„å»ºäº§ç‰©
        for artifact in artifacts/skia-dawn-*; do
          if [ -d "$artifact" ]; then
            echo "æ­£åœ¨åˆå¹¶ $artifact"
            cp -r "$artifact"/* Skia-Final/ 2>/dev/null || true
          fi
        done
        
        # ç¡®ä¿ç›®å½•ç»“æ„æ­£ç¡®
        mkdir -p Skia-Final/include/{core,dawn,modules}
        mkdir -p Skia-Final/bin/{Win/x64,Linux/x64,Android/{arm64,x64}}
        mkdir -p Skia-Final/lib/{Win/x64,Linux/x64,Android/{arm64,x64}}

    - name: åˆ›å»ºCMakeLists.txtä¸»é…ç½®æ–‡ä»¶
      run: |
        cat > Skia-Final/CMakeLists.txt << 'EOF'
        cmake_minimum_required(VERSION 3.20)
        project(SkiaDawn LANGUAGES CXX C)

        set(CMAKE_CXX_STANDARD 20)
        set(CMAKE_CXX_STANDARD_REQUIRED ON)

        # æ£€æµ‹å½“å‰å¹³å°å’Œæ¶æ„
        if(WIN32)
            set(PLATFORM_DIR "Win")
            if(CMAKE_SIZEOF_VOID_P EQUAL 8)
                set(ARCH_DIR "x64")
            else()
                set(ARCH_DIR "x86")
            endif()
        elseif(ANDROID)
            set(PLATFORM_DIR "Android")
            if(CMAKE_ANDROID_ARCH_ABI STREQUAL "arm64-v8a")
                set(ARCH_DIR "arm64")
            elseif(CMAKE_ANDROID_ARCH_ABI STREQUAL "x86_64")
                set(ARCH_DIR "x64")
            endif()
        elseif(UNIX)
            set(PLATFORM_DIR "Linux")
            if(CMAKE_SIZEOF_VOID_P EQUAL 8)
                set(ARCH_DIR "x64")
            else()
                set(ARCH_DIR "x86")
            endif()
        endif()

        # è®¾ç½®åº“å’ŒäºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„
        set(LIB_DIR "${CMAKE_CURRENT_SOURCE_DIR}/lib/${PLATFORM_DIR}/${ARCH_DIR}")
        set(BIN_DIR "${CMAKE_CURRENT_SOURCE_DIR}/bin/${PLATFORM_DIR}/${ARCH_DIR}")

        # DawnåŠ¨æ€åº“ç›®æ ‡ - åŒ…å«ç”Ÿæˆçš„æ–‡ä»¶
        add_library(DawnDynamic INTERFACE)
        target_include_directories(DawnDynamic INTERFACE
            ${CMAKE_CURRENT_SOURCE_DIR}/include/dawn
            ${CMAKE_CURRENT_SOURCE_DIR}/include/core
        )

        # æŸ¥æ‰¾Dawnç›¸å…³çš„åº“æ–‡ä»¶
        file(GLOB DAWN_LIBS 
            "${LIB_DIR}/*dawn*.a" 
            "${LIB_DIR}/*dawn*.lib"
            "${LIB_DIR}/*webgpu*.a" 
            "${LIB_DIR}/*webgpu*.lib"
            "${LIB_DIR}/*tint*.a"
            "${LIB_DIR}/*tint*.lib"
        )
        
        if(DAWN_LIBS)
            target_link_libraries(DawnDynamic INTERFACE ${DAWN_LIBS})
            message(STATUS "æ‰¾åˆ°Dawnåº“æ–‡ä»¶: ${DAWN_LIBS}")
        else()
            message(WARNING "æœªæ‰¾åˆ°Dawnåº“æ–‡ä»¶åœ¨è·¯å¾„: ${LIB_DIR}")
        endif()

        # Skiaä¸»ç›®æ ‡
        add_library(Skia INTERFACE)
        target_include_directories(Skia INTERFACE
            ${CMAKE_CURRENT_SOURCE_DIR}/include/core
            ${CMAKE_CURRENT_SOURCE_DIR}/include/dawn
            ${CMAKE_CURRENT_SOURCE_DIR}/include/modules
        )

        # æŸ¥æ‰¾Skiaåº“æ–‡ä»¶
        file(GLOB SKIA_LIBS 
            "${LIB_DIR}/*skia*.a" 
            "${LIB_DIR}/*skia*.lib"
            "${LIB_DIR}/libskia.*"
        )
        
        if(SKIA_LIBS)
            target_link_libraries(Skia INTERFACE ${SKIA_LIBS})
            message(STATUS "æ‰¾åˆ°Skiaåº“æ–‡ä»¶: ${SKIA_LIBS}")
        else()
            message(WARNING "æœªæ‰¾åˆ°Skiaåº“æ–‡ä»¶åœ¨è·¯å¾„: ${LIB_DIR}")
        endif()

        # é“¾æ¥Dawnåˆ°Skia
        target_link_libraries(Skia INTERFACE DawnDynamic)

        # å¹³å°ç‰¹å®šçš„ç³»ç»Ÿåº“é“¾æ¥
        if(WIN32)
            target_link_libraries(Skia INTERFACE
                d3d11 d3d12 dxgi dxguid
                opengl32 gdi32 user32 kernel32
                vulkan-1
            )
        elseif(ANDROID)
            target_link_libraries(Skia INTERFACE
                GLESv2 EGL vulkan
                android log
            )
        elseif(UNIX)
            target_link_libraries(Skia INTERFACE
                GL vulkan
                X11 Xrandr Xinerama Xcursor Xi
                pthread dl
            )
        endif()

        # è®¾ç½®ç¼–è¯‘å®šä¹‰ - åŒ…å«Graphiteæ”¯æŒ
        target_compile_definitions(Skia INTERFACE
            SK_GANESH=1
            SK_GRAPHITE=1
            SK_GL=1
            SK_VULKAN=1
        )

        if(WIN32)
            target_compile_definitions(Skia INTERFACE
                SK_DIRECT3D=1
                DAWN_ENABLE_D3D11=1
                DAWN_ENABLE_D3D12=1
            )
        endif()

        if(ANDROID)
            target_compile_definitions(Skia INTERFACE
                SK_BUILD_FOR_ANDROID=1
                DAWN_ENABLE_OPENGLES=1
            )
        endif()

        # å¯¼å‡ºç›®æ ‡ä¾›å¤–éƒ¨ä½¿ç”¨
        export(TARGETS Skia DawnDynamic FILE SkiaTargets.cmake)

        # æ˜¾ç¤ºé…ç½®ä¿¡æ¯
        message(STATUS "Skia+Dawnåº“é…ç½®å®Œæˆ")
        message(STATUS "å¹³å°: ${PLATFORM_DIR}")
        message(STATUS "æ¶æ„: ${ARCH_DIR}")
        message(STATUS "åº“ç›®å½•: ${LIB_DIR}")
        message(STATUS "äºŒè¿›åˆ¶ç›®å½•: ${BIN_DIR}")
        message(STATUS "å¯ç”¨Graphiteå’ŒDawn WebGPUæ”¯æŒ")
        EOF

    - name: åˆ›å»ºCMakeé…ç½®æ–‡ä»¶
      run: |
        # åˆ›å»ºåŒ…é…ç½®æ–‡ä»¶
        cat > Skia-Final/SkiaConfig.cmake << 'EOF'
        # Skia+Dawné¢„ç¼–è¯‘åº“é…ç½®æ–‡ä»¶
        include(CMakeFindDependencyMacro)

        # æ£€æŸ¥æ˜¯å¦å·²ç»æ‰¾åˆ°
        if(TARGET Skia)
            return()
        endif()

        # è·å–å½“å‰æ–‡ä»¶æ‰€åœ¨ç›®å½•
        get_filename_component(SKIA_CMAKE_DIR "${CMAKE_CURRENT_LIST_FILE}" PATH)

        # åŒ…å«ç›®æ ‡å®šä¹‰
        if(EXISTS "${SKIA_CMAKE_DIR}/SkiaTargets.cmake")
            include("${SKIA_CMAKE_DIR}/SkiaTargets.cmake")
        else()
            # å¦‚æœç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç›´æ¥åŒ…å«ä¸»CMakeLists.txt
            include("${SKIA_CMAKE_DIR}/CMakeLists.txt")
        endif()

        # è®¾ç½®å˜é‡
        set(Skia_FOUND TRUE)
        set(Skia_VERSION "1.0.0")
        set(Skia_INCLUDE_DIRS 
            "${SKIA_CMAKE_DIR}/include/core"
            "${SKIA_CMAKE_DIR}/include/dawn" 
            "${SKIA_CMAKE_DIR}/include/modules"
        )

        # æä¾›ç»„ä»¶ä¿¡æ¯
        set(Skia_Dawn_FOUND TRUE)
        set(Skia_Core_FOUND TRUE)
        set(Skia_Modules_FOUND TRUE)
        set(Skia_Graphite_FOUND TRUE)

        message(STATUS "Skia+Dawnåº“é…ç½®å·²åŠ è½½ (åŒ…å«Graphiteå’ŒWebGPUæ”¯æŒ)")
        EOF

        # åˆ›å»ºç‰ˆæœ¬æ–‡ä»¶
        cat > Skia-Final/SkiaConfigVersion.cmake << 'EOF'
        set(PACKAGE_VERSION "1.0.0")

        # æ£€æŸ¥ç‰ˆæœ¬å…¼å®¹æ€§
        if(PACKAGE_VERSION VERSION_LESS PACKAGE_FIND_VERSION)
            set(PACKAGE_VERSION_COMPATIBLE FALSE)
        else()
            set(PACKAGE_VERSION_COMPATIBLE TRUE)
            if(PACKAGE_VERSION VERSION_EQUAL PACKAGE_FIND_VERSION)
                set(PACKAGE_VERSION_EXACT TRUE)
            endif()
        endif()
        EOF

    - name: åˆ›å»ºä½¿ç”¨ç¤ºä¾‹
      run: |
        # åˆ›å»ºGraphite+Dawnä½¿ç”¨ç¤ºä¾‹
        cat > Skia-Final/example.cpp << 'EOF'
        // Skia+Dawn+Graphiteé›†æˆä½¿ç”¨ç¤ºä¾‹
        #include "include/core/SkCanvas.h"
        #include "include/core/SkSurface.h"
        #include "include/core/SkImage.h"

        // Ganesh GPUåç«¯
        #include "include/gpu/GrDirectContext.h"
        #include "include/gpu/GrBackendSurface.h"

        // Graphite GPUåç«¯ (æ–°çš„GPUæ¶æ„)
        #ifdef SK_GRAPHITE
        #include "include/gpu/graphite/Context.h"
        #include "include/gpu/graphite/Surface.h"
        #include "include/gpu/graphite/Recording.h"
        #include "include/gpu/graphite/Recorder.h"
        #endif

        // Dawn WebGPUæ”¯æŒ
        #ifdef SK_DAWN
        #include "include/gpu/dawn/GrDawnTypes.h"
        #include "include/dawn/webgpu_cpp.h"
        #ifdef SK_GRAPHITE
        #include "include/gpu/graphite/dawn/DawnTypes.h"
        #endif
        #endif

        #include <iostream>

        int main() {
            std::cout << "Skia+Dawn+Graphiteé›†æˆåº“ç¤ºä¾‹ç¨‹åº" << std::endl;
            
            // æµ‹è¯•CPUè¡¨é¢åŸºæœ¬åŠŸèƒ½
            sk_sp<SkSurface> cpuSurface = SkSurface::MakeRasterN32Premul(800, 600);
            if (!cpuSurface) {
                std::cerr << "æ— æ³•åˆ›å»ºCPUè¡¨é¢" << std::endl;
                return -1;
            }
            
            SkCanvas* canvas = cpuSurface->getCanvas();
            canvas->clear(SK_ColorWHITE);
            
            // ç»˜åˆ¶ç®€å•å›¾å½¢æµ‹è¯•
            SkPaint paint;
            paint.setColor(SK_ColorBLUE);
            canvas->drawCircle(400, 300, 100, paint);
            
            std::cout << "Skia CPUæ¸²æŸ“æµ‹è¯•æˆåŠŸ" << std::endl;
            
        #ifdef SK_GRAPHITE
            std::cout << "Graphite GPUåç«¯æ”¯æŒå·²å¯ç”¨" << std::endl;
            // æ³¨æ„ï¼šå®é™…çš„Graphiteä¸Šä¸‹æ–‡åˆ›å»ºéœ€è¦å…·ä½“çš„GPUåç«¯åˆå§‹åŒ–
            // è¿™é‡Œåªæ˜¯å±•ç¤ºAPIç»“æ„
        #endif
            
        #ifdef SK_DAWN
            std::cout << "Dawn WebGPUæ”¯æŒå·²å¯ç”¨" << std::endl;
            // è¿™é‡Œå¯ä»¥æ·»åŠ Dawn WebGPUçš„åˆå§‹åŒ–å’Œä½¿ç”¨ä»£ç 
            // æ³¨æ„ï¼šéœ€è¦å…ˆåˆå§‹åŒ–WebGPUè®¾å¤‡å’Œä¸Šä¸‹æ–‡
        #endif
            
            return 0;
        }
        EOF

        # åˆ›å»ºCMakeä½¿ç”¨ç¤ºä¾‹
        cat > Skia-Final/ExampleCMakeLists.txt << 'EOF'
        # Skia+Dawn+Graphiteåº“ä½¿ç”¨ç¤ºä¾‹CMakeLists.txt
        cmake_minimum_required(VERSION 3.20)
        project(MySkiaApp LANGUAGES CXX)

        set(CMAKE_CXX_STANDARD 20)
        set(CMAKE_CXX_STANDARD_REQUIRED ON)

        # æŸ¥æ‰¾SkiaåŒ…ï¼ˆè°ƒæ•´è·¯å¾„åˆ°æ‚¨çš„Skiaç›®å½•ï¼‰
        find_package(Skia REQUIRED PATHS "${CMAKE_CURRENT_SOURCE_DIR}/path/to/Skia")

        # åˆ›å»ºæ‚¨çš„åº”ç”¨ç¨‹åº
        add_executable(MyApp example.cpp)

        # é“¾æ¥Skiaåº“
        target_link_libraries(MyApp PRIVATE Skia)

        # å¯é€‰ï¼šè®¾ç½®è¾“å‡ºç›®å½•
        set_target_properties(MyApp PROPERTIES
            RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/bin"
        )

        # æ˜¾ç¤ºé“¾æ¥çš„åº“ä¿¡æ¯
        get_target_property(SKIA_LIBS Skia INTERFACE_LINK_LIBRARIES)
        message(STATUS "é“¾æ¥çš„Skiaåº“: ${SKIA_LIBS}")

        # æ˜¾ç¤ºç¼–è¯‘å®šä¹‰
        get_target_property(SKIA_DEFS Skia INTERFACE_COMPILE_DEFINITIONS)
        message(STATUS "Skiaç¼–è¯‘å®šä¹‰: ${SKIA_DEFS}")
        EOF

    - name: åˆ›å»ºæ–‡æ¡£æ–‡ä»¶
      run: |
        cat > Skia-Final/README.md << 'EOF'
        # Skia + Dawn + Graphite é¢„ç¼–è¯‘åº“

        è¿™æ˜¯ä¸€ä¸ªåŒ…å«Skiaå›¾å½¢åº“ã€Dawn WebGPUå’ŒGraphite GPUåç«¯çš„é¢„ç¼–è¯‘åº“åŒ…ï¼Œæ”¯æŒå¤šå¹³å°å’Œå¤šå›¾å½¢åç«¯ã€‚

        ## æ„å»ºä¿¡æ¯
        - **æ„å»ºç±»å‹**: RelWithDebInfo
        - **C++ æ ‡å‡†**: C++20
        - **ç¼–è¯‘å™¨**: Clang 18, GCC 13, MSVC 2022
        - **ç‰¹æ®ŠåŠŸèƒ½**: å¯ç”¨Graphiteå’ŒDawn WebGPUæ”¯æŒ

        ## æ”¯æŒçš„å¹³å°å’Œåç«¯

        ### Windows (x64)
        - DirectX 11/12
        - Vulkan
        - OpenGL
        - Dawn WebGPU
        - ç¼–è¯‘å™¨: MSVC 2022 + Clang 18

        ### Linux (x64, Ubuntu 24.04)
        - Vulkan
        - OpenGL
        - Dawn WebGPU
        - ç¼–è¯‘å™¨: Clang 18

        ### Android (arm64, x64)
        - Vulkan
        - OpenGL ES (EGL)
        - Dawn WebGPU
        - API Level: 24+
        - STL: c++_static

        ## GPUåç«¯æ¶æ„

        ### Ganesh (ä¼ ç»ŸGPUåç«¯)
        - æˆç†Ÿç¨³å®šçš„GPUæ¸²æŸ“åç«¯
        - æ”¯æŒOpenGLã€Vulkanã€DirectXç­‰
        - å…¼å®¹ç°æœ‰çš„Skiaåº”ç”¨ç¨‹åº

        ### Graphite (æ–°GPUåç«¯)
        - ç°ä»£åŒ–çš„GPUæ¸²æŸ“æ¶æ„
        - æ›´å¥½çš„å¤šçº¿ç¨‹æ”¯æŒ
        - ä¼˜åŒ–çš„å‘½ä»¤ç¼“å†²åŒºç®¡ç†
        - æ”¯æŒDawn WebGPUé›†æˆ

        ## ç›®å½•ç»“æ„
        ```
        Skia/
        â”œâ”€â”€ include/                    # å¤´æ–‡ä»¶ç›®å½•
        â”‚   â”œâ”€â”€ core/                  # Skiaæ ¸å¿ƒå¤´æ–‡ä»¶
        â”‚   â”œâ”€â”€ dawn/                  # Dawn WebGPUå¤´æ–‡ä»¶ï¼ˆåŒ…å«ç”Ÿæˆçš„æ–‡ä»¶ï¼‰
        â”‚   â””â”€â”€ modules/               # Skiaæ¨¡å—å¤´æ–‡ä»¶
        â”œâ”€â”€ bin/                       # å¯æ‰§è¡Œæ–‡ä»¶å’ŒåŠ¨æ€åº“
        â”‚   â”œâ”€â”€ Win/x64/
        â”‚   â”œâ”€â”€ Linux/x64/
        â”‚   â””â”€â”€ Android/{arm64,x64}/
        â”œâ”€â”€ lib/                       # é™æ€åº“æ–‡ä»¶
        â”‚   â”œâ”€â”€ Win/x64/
        â”‚   â”œâ”€â”€ Linux/x64/
        â”‚   â””â”€â”€ Android/{arm64,x64}/
        â”œâ”€â”€ CMakeLists.txt            # ä¸»CMakeé…ç½®æ–‡ä»¶
        â”œâ”€â”€ SkiaConfig.cmake          # CMakeåŒ…é…ç½®æ–‡ä»¶
        â””â”€â”€ SkiaConfigVersion.cmake   # CMakeç‰ˆæœ¬é…ç½®æ–‡ä»¶
        ```

        ## å¿«é€Ÿå¼€å§‹

        ### 1. åŸºæœ¬ä½¿ç”¨æ–¹æ³•
        å°†Skiaç›®å½•å¤åˆ¶åˆ°æ‚¨çš„é¡¹ç›®ä¸­ï¼Œç„¶ååœ¨CMakeLists.txtä¸­æ·»åŠ :

        ```cmake
        # æŸ¥æ‰¾SkiaåŒ…
        find_package(Skia REQUIRED PATHS "${CMAKE_CURRENT_SOURCE_DIR}/path/to/Skia")

        # åˆ›å»ºæ‚¨çš„åº”ç”¨ç¨‹åº
        add_executable(MyApp main.cpp)

        # é“¾æ¥Skiaåº“
        target_link_libraries(MyApp PRIVATE Skia)
        ```

        ### 2. ä½¿ç”¨ä¸åŒçš„GPUåç«¯

        #### Ganeshåç«¯ (ä¼ ç»Ÿ)
        ```cpp
        #include "include/gpu/GrDirectContext.h"
        #include "include/gpu/GrBackendSurface.h"

        // åˆ›å»ºOpenGLä¸Šä¸‹æ–‡
        sk_sp<GrDirectContext> context = GrDirectContext::MakeGL();
        ```

        #### Graphiteåç«¯ (ç°ä»£)
        ```cpp
        #ifdef SK_GRAPHITE
        #include "include/gpu/graphite/Context.h"
        #include "include/gpu/graphite/Recorder.h"

        // åˆ›å»ºGraphiteä¸Šä¸‹æ–‡
        std::unique_ptr<skgpu::graphite::Context> context = 
            skgpu::graphite::Context::MakeDawn(dawnDevice);
        #endif
        ```

        #### Dawn WebGPUé›†æˆ
        ```cpp
        #ifdef SK_DAWN
        #include "include/dawn/webgpu_cpp.h"
        #include "include/gpu/graphite/dawn/DawnTypes.h"

        // åˆå§‹åŒ–WebGPUè®¾å¤‡
        wgpu::Device device = CreateWebGPUDevice();
        
        // åˆ›å»ºGraphiteä¸Šä¸‹æ–‡
        auto context = skgpu::graphite::Context::MakeDawn(
            skgpu::graphite::DawnBackendContext{device}
        );
        #endif
        ```

        ## ç¼–è¯‘å®šä¹‰
        åº“ä¼šè‡ªåŠ¨è®¾ç½®ä»¥ä¸‹ç¼–è¯‘å®šä¹‰:
        - `SK_GANESH=1` - å¯ç”¨Ganesh GPUåç«¯
        - `SK_GRAPHITE=1` - å¯ç”¨Graphite GPUåç«¯
        - `SK_GL=1` - å¯ç”¨OpenGLæ”¯æŒ
        - `SK_VULKAN=1` - å¯ç”¨Vulkanæ”¯æŒ
        - `SK_DIRECT3D=1` - å¯ç”¨DirectXæ”¯æŒ (Windows)
        - `SK_BUILD_FOR_ANDROID=1` - Androidæ„å»ºæ ‡è¯† (Android)
        - `DAWN_ENABLE_*` - Dawnåç«¯æ”¯æŒæ ‡è¯†

        ## ç‰¹æ®ŠåŠŸèƒ½

        ### Graphite + Dawn WebGPU
        - å®Œæ•´çš„WebGPU APIæ”¯æŒ
        - è·¨å¹³å°GPUæŠ½è±¡å±‚
        - ç°ä»£åŒ–çš„å›¾å½¢ç®¡çº¿
        - ä¼˜åŒ–çš„èµ„æºç®¡ç†

        ### åŠ¨æ€ç”Ÿæˆæ–‡ä»¶
        - åŒ…å«Dawnè¿è¡Œæ—¶ç”Ÿæˆçš„å¤´æ–‡ä»¶
        - è‡ªåŠ¨å¤„ç†WebGPUç»‘å®š
        - å®Œæ•´çš„Tintç€è‰²å™¨ç¼–è¯‘å™¨æ”¯æŒ

        ## æ•…éšœæ’é™¤

        ### å¸¸è§é—®é¢˜
        1. **Graphiteç›¸å…³é”™è¯¯**: ç¡®ä¿ä½¿ç”¨æ”¯æŒçš„GPUåç«¯
        2. **Dawnåˆå§‹åŒ–å¤±è´¥**: æ£€æŸ¥WebGPUé©±åŠ¨ç¨‹åºæ”¯æŒ
        3. **é“¾æ¥é”™è¯¯**: ç¡®ä¿æ‰€æœ‰Dawnåº“éƒ½è¢«æ­£ç¡®é“¾æ¥

        ### ä¾èµ–çš„ç³»ç»Ÿåº“
        - **Windows**: d3d11.lib, d3d12.lib, dxgi.lib, opengl32.lib, vulkan-1.lib
        - **Linux**: libGL, libvulkan, libX11ç­‰X11åº“
        - **Android**: libGLESv2, libEGL, libvulkan, libandroid

        ## ç‰ˆæœ¬å…¼å®¹æ€§
        - æ”¯æŒæœ€æ–°çš„WebGPUè§„èŒƒ
        - å…¼å®¹Skiaä¸»åˆ†æ”¯API
        - æ”¯æŒGraphiteå®éªŒæ€§åŠŸèƒ½

        ## æŠ€æœ¯æ”¯æŒ
        å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥:
        1. CMakeç‰ˆæœ¬ >= 3.20
        2. C++ç¼–è¯‘å™¨æ”¯æŒC++20æ ‡å‡†
        3. ç›®æ ‡å¹³å°çš„WebGPUé©±åŠ¨ç¨‹åºå·²æ­£ç¡®å®‰è£…
        4. GraphiteåŠŸèƒ½åœ¨ç›®æ ‡è®¾å¤‡ä¸Šå—æ”¯æŒ
        EOF

        # åˆ›å»ºæ„å»ºä¿¡æ¯æ–‡ä»¶
        cat > Skia-Final/BuildInfo.txt << 'EOF'
        Skia + Dawn + Graphite é¢„ç¼–è¯‘åº“æ„å»ºä¿¡æ¯
        ===============================================

        æ„å»ºé…ç½®:
        - æ„å»ºç±»å‹: RelWithDebInfo
        - C++ æ ‡å‡†: C++20
        - ä¼˜åŒ–çº§åˆ«: O2 + è°ƒè¯•ä¿¡æ¯

        æ”¯æŒçš„ç¼–è¯‘å™¨:
        - Windows: MSVC 2022 + Clang 18
        - Linux: Clang 18
        - Android: Clang (NDK r26d)

        å¯ç”¨çš„SkiaåŠŸèƒ½:
        - Ganesh GPUåç«¯ (ä¼ ç»Ÿ)
        - Graphite GPUåç«¯ (ç°ä»£) âœ¨
        - Dawn WebGPUæ”¯æŒ âœ¨
        - Vulkanæ”¯æŒ
        - OpenGL/OpenGL ESæ”¯æŒ
        - DirectX 11/12æ”¯æŒ (Windows)

        ç¦ç”¨çš„åŠŸèƒ½ï¼ˆå‡å°‘ä½“ç§¯ï¼‰:
        - SkottieåŠ¨ç”»æ”¯æŒ
        - SVGæ”¯æŒ
        - PDFæ”¯æŒ
        - å·¥å…·å’Œç¤ºä¾‹ç¨‹åº
        - å•å…ƒæµ‹è¯•å’ŒåŸºå‡†æµ‹è¯•
        - WebAssemblyæ”¯æŒ

        Dawné…ç½®:
        - å¯ç”¨çš„åç«¯: D3D11, D3D12, Vulkan, OpenGL, OpenGL ES
        - ç¦ç”¨çš„åŠŸèƒ½: ç¤ºä¾‹ç¨‹åºã€æµ‹è¯•ã€Node.jsç»‘å®š
        - åŒ…å«åŠ¨æ€ç”Ÿæˆçš„å¤´æ–‡ä»¶å’Œæºç 
        - é›†æˆTintç€è‰²å™¨ç¼–è¯‘å™¨

        ç‰¹æ®Šæ³¨æ„äº‹é¡¹:
        - Graphiteæ˜¯Skiaçš„å®éªŒæ€§æ–°GPUåç«¯
        - Dawnæä¾›è·¨å¹³å°WebGPUæŠ½è±¡
        - æ‰€æœ‰åç«¯å·²åˆå¹¶åˆ°å•ä¸€åº“æ–‡ä»¶ä¸­
        - æ”¯æŒç°ä»£GPUç¼–ç¨‹æ¨¡å¼
        EOF

    - name: éªŒè¯æ„å»ºäº§ç‰©ç»“æ„
      run: |
        echo "=== éªŒè¯æœ€ç»ˆæ„å»ºäº§ç‰©ç»“æ„ ==="
        find Skia-Final -type f -name "*.lib" -o -name "*.a" -o -name "*.so" | head -20
        echo ""
        echo "=== å¤´æ–‡ä»¶ç›®å½•ç»“æ„ ==="
        find Skia-Final/include -type d | head -10
        echo ""
        echo "=== CMakeæ–‡ä»¶ ==="
        ls -la Skia-Final/*.cmake Skia-Final/CMakeLists.txt 2>/dev/null || echo "CMakeæ–‡ä»¶æœªæ‰¾åˆ°"
        echo ""
        echo "=== æ–‡æ¡£æ–‡ä»¶ ==="
        ls -la Skia-Final/*.md Skia-Final/*.txt 2>/dev/null || echo "æ–‡æ¡£æ–‡ä»¶æœªæ‰¾åˆ°"

    - name: åˆ›å»ºæœ€ç»ˆå‹ç¼©åŒ…
      run: |
        cd Skia-Final
        zip -r ../Skia.zip . -x "*.git*" "*.DS_Store"
        cd ..
        echo "=== æœ€ç»ˆæ–‡ä»¶ä¿¡æ¯ ==="
        ls -lh Skia.zip
        echo ""
        echo "=== å‹ç¼©åŒ…å†…å®¹é¢„è§ˆ ==="
        unzip -l Skia.zip | head -30

    - name: ä¸Šä¼ æœ€ç»ˆæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: Skia-Final-Package
        path: Skia.zip

    - name: å‘å¸ƒRelease (ä»…ä¸»åˆ†æ”¯)
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: build-${{ github.run_number }}
        name: Skia + Dawn + Graphite é¢„ç¼–è¯‘åº“ v${{ github.run_number }}
        body: |
          # Skia + Dawn + Graphite é¢„ç¼–è¯‘åº“ è‡ªåŠ¨æ„å»ºç‰ˆæœ¬

          æ­¤ç‰ˆæœ¬åŒ…å«ç»è¿‡ä¼˜åŒ–çš„Skiaã€Dawn WebGPUå’ŒGraphite GPUåç«¯é¢„ç¼–è¯‘åº“ï¼Œæ”¯æŒå¤šå¹³å°å’Œç°ä»£GPUç¼–ç¨‹ã€‚

          ## ğŸš€ æ–°åŠŸèƒ½ç‰¹æ€§
          - **Graphite GPUåç«¯**: ç°ä»£åŒ–çš„GPUæ¸²æŸ“æ¶æ„
          - **Dawn WebGPUé›†æˆ**: è·¨å¹³å°WebGPUæŠ½è±¡å±‚
          - **ä¼˜åŒ–çš„ç£ç›˜ä½¿ç”¨**: ç²¾ç®€æ„å»ºé…ç½®ï¼Œå‡å°‘ä¸å¿…è¦çš„ä¾èµ–
          - **å¤šå¹³å°æ”¯æŒ**: Windows x64, Linux x64, Android arm64/x64
          - **CMakeé›†æˆ**: å¼€ç®±å³ç”¨çš„CMakeé…ç½®

          ## ğŸ“‹ æ”¯æŒçš„å›¾å½¢åç«¯
          - **Windows**: DirectX 11/12, Vulkan, OpenGL, WebGPU
          - **Linux**: Vulkan, OpenGL, WebGPU
          - **Android**: Vulkan, OpenGL ES, WebGPU

          ## ğŸ› ï¸ æŠ€æœ¯è§„æ ¼
          - C++20 æ ‡å‡†
          - RelWithDebInfo æ„å»ºé…ç½®
          - Ganesh + GraphiteåŒGPUåç«¯
          - Dawn WebGPUæ”¯æŒ
          - åŒ…å«åŠ¨æ€ç”Ÿæˆæ–‡ä»¶

          ## ğŸ¯ é€‚ç”¨åœºæ™¯
          - ç°ä»£å›¾å½¢åº”ç”¨ç¨‹åºå¼€å‘
          - è·¨å¹³å°GPUç¼–ç¨‹
          - WebGPUåº”ç”¨ç¨‹åº
          - é«˜æ€§èƒ½2D/3Då›¾å½¢æ¸²æŸ“

          ## ğŸ“¦ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ `Skia.zip` å¹¶è§£å‹
          2. å‚è€ƒåŒ…å†…çš„ `README.md` å’Œç¤ºä¾‹æ–‡ä»¶
          3. ä½¿ç”¨CMakeé›†æˆåˆ°æ‚¨çš„é¡¹ç›®ä¸­
          4. é€‰æ‹©Ganeshæˆ–Graphite GPUåç«¯

          ## âš ï¸ æ³¨æ„äº‹é¡¹
          - Graphiteæ˜¯å®éªŒæ€§GPUåç«¯ï¼ŒAPIå¯èƒ½ä¼šå˜åŒ–
          - ç¡®ä¿ç›®æ ‡ç³»ç»Ÿæ”¯æŒWebGPU
          - Androidéœ€è¦API Level 24æˆ–æ›´é«˜ç‰ˆæœ¬
          - å»ºè®®ä½¿ç”¨CMake 3.20æˆ–æ›´é«˜ç‰ˆæœ¬
        files: Skia.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
